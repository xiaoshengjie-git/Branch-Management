{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">æ™ºæ…§æµ·æ´‹ç‰§åœºå¯è§†åŒ–ç³»ç»Ÿ - <span id="ranchNameTitle">è¯·é€‰æ‹©æµ·æ´‹ç‰§åœº</span></h1>

    <!-- ç³»ç»Ÿæ¦‚è§ˆå¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-globe me-2"></i>æµ·åŸŸé¢ç§¯</h5>
                    <p class="card-text" id="seaArea">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-fish me-2"></i>å…»æ®–ç§ç±»</h5>
                    <p class="card-text" id="speciesCount">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-water me-2"></i>æ°´è´¨å¤©æ°”</h5>
                    <p class="card-text" id="waterQuality">-</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-exclamation-triangle me-2"></i>å‘Šè­¦æ•°é‡</h5>
                    <p class="card-text" id="alertCount">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ°´åŸŸè¯¦ç»†ä»‹ç» -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-map-marked-alt me-2"></i>æ°´åŸŸä»‹ç»
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>åŸºæœ¬ä¿¡æ¯</h5>
                            <ul class="list-unstyled">
                                <li><strong>ä½ç½®ï¼š</strong><span id="location">-</span></li>
                                <li><strong>æ°´æ·±ï¼š</strong><span id="waterDepth">-</span></li>
                                <li><strong>æµ·æµæƒ…å†µï¼š</strong><span id="currentStatus">-</span></li>
                                <li><strong>å»ºè®¾æ—¶é—´ï¼š</strong><span id="establishTime">-</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>ç‰¹è‰²ä»‹ç»</h5>
                            <p id="introduction">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…»æ®–ç§ç±»è¯¦æƒ… -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-fish me-2"></i>å…»æ®–ç§ç±»è¯¦æƒ…
                </div>
                <div class="card-body">
                    <div id="speciesList" class="row">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„å…»æ®–ç§ç±»å¡ç‰‡ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- ç³»ç»Ÿå‘Šè­¦ä¿¡æ¯ -->
        <div class="col-md-6">
            <div class="card">
                <!-- <div class="card-header">
                    <i class="fas fa-bell me-2"></i>ç³»ç»Ÿå‘Šè­¦ä¿¡æ¯
                </div>
                    <button class="btn btn-outline-danger btn-sm clear-btn" onclick="clearAllAlerts()" id="clearBtn">
                        <i class="fas fa-trash me-1"></i>æ¸…é™¤æ‰€æœ‰
                    </button> -->
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-bell me-2"></i>ç³»ç»Ÿå‘Šè­¦ä¿¡æ¯
                    </div>
                    <button class="btn btn-outline-danger btn-sm clear-btn" onclick="deleteAllAlertsHandler(getCurrentRanchName())" id="clearBtn">
                        <i class="fas fa-trash me-1"></i>æ¸…é™¤æ‰€æœ‰
                    </button>
                </div>
                <div class="card-body" id="alertsContainer" style="max-height: 300px; overflow-y: auto;">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„å‘Šè­¦ä¿¡æ¯ -->
                </div>
            </div>
        </div>

        <!-- å®æ—¶è§†é¢‘ç›‘æ§ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-video me-2"></i>å®æ—¶è§†é¢‘ç›‘æ§
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-dark text-white">
                                    æ‘„åƒå¤´ 1
                                </div>
                                <div class="card-body p-0">
                                    <video width="100%" height="auto" controls autoplay muted loop>
                                        <source src="{{ url_for('static', filename='videos/çŠç‘šé±¼ç¾¤.mp4') }}" type="video/mp4">
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
                                    </video>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-dark text-white">
                                    æ‘„åƒå¤´ 2
                                </div>
                                <div class="card-body p-0">
                                    <video width="100%" height="auto" controls autoplay muted loop>
                                        <source src="{{ url_for('static', filename='videos/æµ·åº•é£å…‰.mp4') }}" type="video/mp4">
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/*
    * æµ·æ´‹ç‰§åœºæ•°æ®
*/

    // å„æµ·æ´‹ç‰§åœºçš„è¯¦ç»†æ•°æ®
    const marineRanchData = {
        0: { // å±±ä¸œé’å²›
            name: 'é’å²›å›½å®¶çº§æµ·æ´‹ç‰§åœºç¤ºèŒƒåŒº',
            seaArea: '850å¹³æ–¹å…¬é‡Œ',
            speciesCount: '12ç§',
            waterQuality: 'ä¼˜ç§€',
            alertCount: '2ä¸ª',
            location: 'é’å²›å¸‚é»„å²›åŒºä¸œæµ·å²¸',
            waterDepth: '15-45ç±³',
            currentStatus: 'æµ·æµç¨³å®šï¼Œé€‚å®œå…»æ®–',
            establishTime: '2018å¹´6æœˆ',
            introduction: 'é’å²›æµ·æ´‹ç‰§åœºæ˜¯å›½å®¶é¦–æ‰¹è®¤å®šçš„æµ·æ´‹ç‰§åœºç¤ºèŒƒåŒºï¼Œæ‹¥æœ‰å…ˆè¿›çš„æ™ºèƒ½åŒ–ç®¡ç†ç³»ç»Ÿå’Œå®Œå–„çš„ç”Ÿæ€å…»æ®–ä½“ç³»ã€‚è¯¥åŒºåŸŸæµ·æ°´æ¸…æ¾ˆï¼Œç”Ÿæ€ç¯å¢ƒä¼˜è‰¯ï¼Œæ˜¯å¤šç§æµ·æ´‹ç”Ÿç‰©çš„ç†æƒ³æ –æ¯åœ°ã€‚',
            species: [
                { name: 'æµ·å‚', quantity: '200ä¸‡å¤´', status: 'ç”Ÿé•¿è‰¯å¥½' },
                { name: 'é²é±¼', quantity: '150ä¸‡åª', status: 'æ­£å¸¸' },
                { name: 'æ‰‡è´', quantity: '500ä¸‡åª', status: 'ä¸°æ”¶æœŸ' },
                { name: 'æµ·èƒ†', quantity: '80ä¸‡åª', status: 'ç”Ÿé•¿ä¸­' }
            ],
            alerts: [
                { level: 'warning', type: 'è®¾å¤‡å¼‚å¸¸', message: '3å·æµ®æ ‡ä¿¡å·å¼±ï¼Œè¯·æ£€æŸ¥ç”µæ± ã€‚' },
                { level: 'info', type: 'å¤©æ°”å¼‚å¸¸', message: 'æ˜æ—¥æœ‰å°åˆ°ä¸­é›¨ï¼Œè¯·åšå¥½é˜²æŠ¤å‡†å¤‡ã€‚' }
            ]
        },
        1: { // æµ™æ±ŸèˆŸå±±
            name: 'èˆŸå±±ç¾¤å²›æµ·æ´‹ç‰§åœº',
            seaArea: '620å¹³æ–¹å…¬é‡Œ',
            speciesCount: '15ç§',
            waterQuality: 'è‰¯å¥½',
            alertCount: '3ä¸ª',
            location: 'èˆŸå±±å¸‚æ™®é™€åŒºä¸œæµ·æµ·åŸŸ',
            waterDepth: '20-60ç±³',
            currentStatus: 'æµ·æµæ´»è·ƒï¼Œè¥å…»ä¸°å¯Œ',
            establishTime: '2019å¹´3æœˆ',
            introduction: 'èˆŸå±±æµ·æ´‹ç‰§åœºä½äºä¸œæµ·æ¸”åœºæ ¸å¿ƒåŒºåŸŸï¼Œæ˜¯æˆ‘å›½é‡è¦çš„æµ·æ´‹æ¸”ä¸šåŸºåœ°ã€‚è¯¥ç‰§åœºå……åˆ†åˆ©ç”¨èˆŸå±±ç¾¤å²›ç‹¬ç‰¹çš„åœ°ç†ä¼˜åŠ¿ï¼Œå‘å±•æ·±æ°´å…»æ®–å’Œç”Ÿæ€æ—…æ¸¸ã€‚',
            species: [
                { name: 'é»„é±¼', quantity: '300ä¸‡å°¾', status: 'ç”Ÿé•¿è‰¯å¥½' },
                { name: 'å¸¦é±¼', quantity: '180ä¸‡å°¾', status: 'æ­£å¸¸' },
                { name: 'çŸ³æ–‘é±¼', quantity: '50ä¸‡å°¾', status: 'åŸ¹è‚²æœŸ' },
                { name: 'æ¢­å­èŸ¹', quantity: '120ä¸‡åª', status: 'æ”¶è·æœŸ' },
                { name: 'å¤§é»„é±¼', quantity: '200ä¸‡å°¾', status: 'ç”Ÿé•¿ä¸­' }
            ],
            alerts: []
        },
        2: { // ç¦å»ºå¦é—¨
            name: 'å¦é—¨æ¹¾æµ·æ´‹ç‰§åœº',
            seaArea: '380å¹³æ–¹å…¬é‡Œ',
            speciesCount: '10ç§',
            waterQuality: 'è‰¯å¥½',
            alertCount: '1ä¸ª',
            location: 'å¦é—¨å¸‚ç¿”å®‰åŒºæµ·åŸŸ',
            waterDepth: '10-35ç±³',
            currentStatus: 'æ°´æ¸©é€‚å®œï¼Œæµ·æµå¹³ç¨³',
            establishTime: '2020å¹´1æœˆ',
            introduction: 'å¦é—¨æ¹¾æµ·æ´‹ç‰§åœºç»“åˆäº†ä¼ ç»Ÿå…»æ®–ä¸ç°ä»£ç§‘æŠ€ï¼Œæ‰“é€ äº†é›†å…»æ®–ã€ç§‘ç ”ã€è§‚å…‰äºä¸€ä½“çš„ç»¼åˆæ€§æµ·æ´‹ç‰§åœºã€‚',
            species: [
                { name: 'çŸ³æ–‘é±¼', quantity: '100ä¸‡å°¾', status: 'ç”Ÿé•¿è‰¯å¥½' },
                { name: 'é²ˆé±¼', quantity: '150ä¸‡å°¾', status: 'æ­£å¸¸' },
                { name: 'ç‰¡è›', quantity: '800ä¸‡åª', status: 'æ”¶è·æœŸ' },
                { name: 'é’èŸ¹', quantity: '60ä¸‡åª', status: 'åŸ¹è‚²ä¸­' }
            ],
            alerts: []
        },
        3: { // å¹¿ä¸œæ¹›æ±Ÿ
            name: 'æ¹›æ±Ÿæµ·æ´‹ç‰§åœº',
            seaArea: '450å¹³æ–¹å…¬é‡Œ',
            speciesCount: '8ç§',
            waterQuality: 'ä¼˜ç§€',
            alertCount: '0ä¸ª',
            location: 'æ¹›æ±Ÿå¸‚å¾é—»å¿æµ·åŸŸ',
            waterDepth: '15-40ç±³',
            currentStatus: 'çƒ­å¸¦æµ·åŸŸï¼Œæ°´æ¸©æ’å®š',
            establishTime: '2019å¹´9æœˆ',
            introduction: 'æ¹›æ±Ÿæµ·æ´‹ç‰§åœºä½äºä¸­å›½å¤§é™†æœ€å—ç«¯ï¼Œæ‹¥æœ‰å¾—å¤©ç‹¬åšçš„çƒ­å¸¦æµ·æ´‹èµ„æºï¼Œé€‚åˆå¤šç§çƒ­å¸¦é±¼ç±»å…»æ®–ã€‚',
            species: [
                { name: 'é‡‘é²³é±¼', quantity: '250ä¸‡å°¾', status: 'ç”Ÿé•¿è‰¯å¥½' },
                { name: 'å†›æ›¹é±¼', quantity: '180ä¸‡å°¾', status: 'æ­£å¸¸' },
                { name: 'çç è´', quantity: '500ä¸‡åª', status: 'åŸ¹è‚²æœŸ' },
                { name: 'é¾™è™¾', quantity: '30ä¸‡åª', status: 'ç”Ÿé•¿ä¸­' }
            ],
            alerts: []
        },
        4: { // è¾½å®å¤§è¿
            name: 'å¤§è¿æµ·æ´‹ç‰§åœº',
            seaArea: '720å¹³æ–¹å…¬é‡Œ',
            speciesCount: '14ç§',
            waterQuality: 'è‰¯å¥½',
            alertCount: '4ä¸ª',
            location: 'å¤§è¿å¸‚é•¿æµ·å¿æµ·åŸŸ',
            waterDepth: '20-55ç±³',
            currentStatus: 'å†·æ°´æ€§æµ·åŸŸï¼Œé€‚åˆå†·æ°´é±¼ç±»',
            establishTime: '2017å¹´5æœˆ',
            introduction: 'å¤§è¿æµ·æ´‹ç‰§åœºæ˜¯åŒ—æ–¹é‡è¦çš„æµ·æ´‹å…»æ®–åŸºåœ°ï¼Œä¸“æ³¨äºå†·æ°´æ€§ç»æµé±¼ç±»å’Œæµ·çå“çš„å…»æ®–ï¼Œæ‹¥æœ‰å®Œå–„çš„å†·é“¾ç‰©æµä½“ç³»ã€‚',
            species: [
                { name: 'æµ·å‚', quantity: '300ä¸‡å¤´', status: 'ç”Ÿé•¿è‰¯å¥½' },
                { name: 'é²é±¼', quantity: '200ä¸‡åª', status: 'æ­£å¸¸' },
                { name: 'æµ·èƒ†', quantity: '150ä¸‡åª', status: 'æ”¶è·æœŸ' },
                { name: 'æ‰‡è´', quantity: '600ä¸‡åª', status: 'åŸ¹è‚²ä¸­' },
                { name: 'æµ·èº', quantity: '100ä¸‡åª', status: 'ç”Ÿé•¿ä¸­' }
            ],
            alerts: []
        },
        5: { // æ²³åŒ—ç§¦çš‡å²›
            name: 'ç§¦çš‡å²›æµ·æ´‹ç‰§åœº',
            seaArea: '320å¹³æ–¹å…¬é‡Œ',
            speciesCount: '9ç§',
            waterQuality: 'è‰¯å¥½',
            alertCount: '2ä¸ª',
            location: 'ç§¦çš‡å²›å¸‚åŒ—æˆ´æ²³æ–°åŒºæµ·åŸŸ',
            waterDepth: '10-30ç±³',
            currentStatus: 'æ¸¤æµ·æ¹¾å†…ï¼Œé£æµªè¾ƒå°',
            establishTime: '2020å¹´7æœˆ',
            introduction: 'ç§¦çš‡å²›æµ·æ´‹ç‰§åœºä½äºæ¸¤æµ·æ¹¾å†…ï¼Œç¯å¢ƒç›¸å¯¹å°é—­ï¼Œé€‚åˆå‘å±•ä¼‘é—²æ¸”ä¸šå’Œç”Ÿæ€æ—…æ¸¸ï¼Œæ˜¯äº¬æ´¥å†€åœ°åŒºé‡è¦çš„æµ·äº§å“ä¾›åº”åŸºåœ°ã€‚',
            species: [
                { name: 'å¯¹è™¾', quantity: '400ä¸‡å°¾', status: 'ç”Ÿé•¿è‰¯å¥½' },
                { name: 'æ¢­å­èŸ¹', quantity: '180ä¸‡åª', status: 'æ­£å¸¸' },
                { name: 'è´ç±»', quantity: '600ä¸‡åª', status: 'ä¸°æ”¶æœŸ' },
                { name: 'æµ·èœ‡', quantity: '50ä¸‡åª', status: 'åŸ¹è‚²ä¸­' }
            ],
            alerts: []
        }
    };

/*
    * æŠ¥è­¦å¤„ç†
*/

    // CSVæ–‡ä»¶æ“ä½œ
    const csvOperations = {
        // ä»CSVæ–‡ä»¶åŠ è½½è­¦æŠ¥
        loadAlertsFromCSV: async function(ranchName) {
            try {
                // è°ƒç”¨APIè·å–è­¦æŠ¥æ•°æ®
                const response = await fetch(`/api/alerts/${encodeURIComponent(ranchName)}`);
                if (!response.ok) {
                    console.error('åŠ è½½è­¦æŠ¥æ•°æ®å¤±è´¥:', response.statusText);
                    return [];
                }
                
                const alerts = await response.json();
                return alerts;
            } catch (error) {
                console.error('åŠ è½½è­¦æŠ¥æ•°æ®æ—¶å‡ºé”™:', error);
                return [];
            }
        },
        
        // æ›´æ–°è­¦æŠ¥åˆ°CSVæ–‡ä»¶
        updateAlertsInCSV: async function(ranchName, newAlerts) {
            try {
                // è°ƒç”¨APIæ›´æ–°è­¦æŠ¥æ•°æ®
                const response = await fetch(`/api/alerts/${encodeURIComponent(ranchName)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newAlerts)
                });
                
                if (!response.ok) {
                    console.error('æ›´æ–°è­¦æŠ¥æ•°æ®å¤±è´¥:', response.statusText);
                    return [];
                }
                
                const updatedAlerts = await response.json();
                return updatedAlerts;
            } catch (error) {
                console.error('æ›´æ–°è­¦æŠ¥æ•°æ®æ—¶å‡ºé”™:', error);
                return [];
            }
        },
        
        // åˆ é™¤ç‰¹å®šè­¦æŠ¥
        deleteAlert: async function(ranchName, alertIndex) {
            try {
                // è°ƒç”¨APIåˆ é™¤è­¦æŠ¥
                const response = await fetch(`/api/alerts/${encodeURIComponent(ranchName)}/${alertIndex}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    console.error('åˆ é™¤è­¦æŠ¥å¤±è´¥:', response.statusText);
                    return null;
                }
                
                const result = await response.json();
                return result.alerts;
            } catch (error) {
                console.error('åˆ é™¤è­¦æŠ¥æ—¶å‡ºé”™:', error);
                return null;
            }
        },

        // åˆ é™¤æ‰€æœ‰è­¦æŠ¥
        deleteAllAlerts: async function(ranchName) {
            try {
                // è°ƒç”¨APIåˆ é™¤æ‰€æœ‰è­¦æŠ¥
                const response = await fetch(`/api/alerts/${encodeURIComponent(ranchName)}/all`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    console.error('åˆ é™¤æ‰€æœ‰è­¦æŠ¥å¤±è´¥:', response.statusText);
                    return null;
                }
                
                const result = await response.json();
                return result.alerts; // è¿”å›ç©ºæ•°ç»„
            } catch (error) {
                console.error('åˆ é™¤æ‰€æœ‰è­¦æŠ¥æ—¶å‡ºé”™:', error);
                return null;
            }
        },
        
        // åˆå§‹åŒ–æ‰€æœ‰ç‰§åœºçš„è­¦æŠ¥æ–‡ä»¶
        initAlertsFiles: async function(ranchNames) {
            try {
                // è°ƒç”¨APIåˆå§‹åŒ–è­¦æŠ¥æ–‡ä»¶
                const response = await fetch('/api/init_alerts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ranch_names: ranchNames })
                });
                
                if (!response.ok) {
                    console.error('åˆå§‹åŒ–è­¦æŠ¥æ–‡ä»¶å¤±è´¥:', response.statusText);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('åˆå§‹åŒ–è­¦æŠ¥æ–‡ä»¶æ—¶å‡ºé”™:', error);
                return false;
            }
        }
    };

    // åˆ é™¤è­¦æŠ¥çš„å¤„ç†å‡½æ•°
    async function deleteAlertHandler(ranchName, alertIndex) {
        // ç¡®è®¤åˆ é™¤
        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è­¦æŠ¥å—ï¼Ÿ')) {
            // è°ƒç”¨APIåˆ é™¤è­¦æŠ¥
            const updatedAlerts = await csvOperations.deleteAlert(ranchName, alertIndex);
            
            if (updatedAlerts) {
                // æ›´æ–°å½“å‰æ˜¾ç¤º
                const currentIndex = document.getElementById('marineFarmSelect').value;
                if (currentIndex !== '') {
                    await updateRanchContent(currentIndex);
                }
            }
        }
    }

    // åˆ é™¤æ‰€æœ‰è­¦æŠ¥çš„å¤„ç†å‡½æ•°
    async function deleteAllAlertsHandler(ranchName) {
        // æ£€æŸ¥ç‰§åœºåç§°æ˜¯å¦æœ‰æ•ˆ
        if (!ranchName) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç‰§åœº');
            return;
        }
        
        // ç¡®è®¤åˆ é™¤
        if (confirm(`ç¡®å®šè¦åˆ é™¤ "${ranchName}" ç‰§åœºçš„æ‰€æœ‰è­¦æŠ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const clearBtn = document.getElementById('clearBtn');
                if (clearBtn) {
                    clearBtn.disabled = true;
                    clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åˆ é™¤ä¸­...';
                }
                
                // è°ƒç”¨APIåˆ é™¤æ‰€æœ‰è­¦æŠ¥
                const result = await csvOperations.deleteAllAlerts(ranchName);
                
                if (result !== null) {
                    // åˆ é™¤æˆåŠŸï¼Œæ›´æ–°å½“å‰æ˜¾ç¤º
                    const currentIndex = document.getElementById('marineFarmSelect').value;
                    if (currentIndex !== '') {
                        await updateRanchContent(currentIndex);
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    alert('æ‰€æœ‰è­¦æŠ¥å·²æˆåŠŸåˆ é™¤ï¼');
                } else {
                    // åˆ é™¤å¤±è´¥
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('åˆ é™¤æ‰€æœ‰è­¦æŠ¥æ—¶å‡ºé”™:', error);
                alert('åˆ é™¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const clearBtn = document.getElementById('clearBtn');
                if (clearBtn) {
                    clearBtn.disabled = false;
                    clearBtn.innerHTML = '<i class="fas fa-trash me-1"></i>æ¸…é™¤æ‰€æœ‰';
                }
            }
        }
    }

    // è·å–å½“å‰é€‰ä¸­ç‰§åœºåç§°çš„å‡½æ•°
    function getCurrentRanchName() {
        const selectedIndex = localStorage.getItem('selectedMarineFarm');
        const selectedRanch = marineRanches[selectedIndex];
        return selectedRanch.name;
    }

    // å¼¹çª—è­¦æŠ¥ç³»ç»Ÿ
    const alertPopupSystem = {
        // å­˜å‚¨å·²ç»æ˜¾ç¤ºè¿‡çš„è­¦æŠ¥IDï¼Œé˜²æ­¢é‡å¤å¼¹çª—
        shownAlerts: new Set(),
        
        // æ‰¹é‡å¤„ç†è­¦æŠ¥çš„é…ç½®
        batchConfig: {
            maxSingleAlerts: 2,      // æœ€å¤šå•ç‹¬æ˜¾ç¤º2ä¸ªè­¦æŠ¥
            batchDelay: 500,         // æ‰¹é‡æ”¶é›†å»¶è¿Ÿæ—¶é—´(ms)
            priorityLevels: {        // ä¼˜å…ˆçº§é…ç½®
                'danger': 3,
                'warning': 2,
                'info': 1
            }
        },
        
        // å¾…å¤„ç†çš„è­¦æŠ¥é˜Ÿåˆ—
        pendingAlerts: [],
        batchTimer: null,
        
        // ä¸»è¦çš„è­¦æŠ¥æ˜¾ç¤ºæ–¹æ³• - æ”¯æŒæ‰¹é‡å¤„ç†
        showAlerts(alerts) {
            if (!Array.isArray(alerts)) {
                alerts = [alerts];
            }
            
            // è¿‡æ»¤æ‰å·²æ˜¾ç¤ºçš„è­¦æŠ¥
            const newAlerts = alerts.filter(alert => {
                const alertId = `${alert.message}-${alert.timestamp}`;
                if (this.shownAlerts.has(alertId)) {
                    return false;
                }
                this.shownAlerts.add(alertId);
                return true;
            });
            
            if (newAlerts.length === 0) {
                return;
            }
            
            // æ ¹æ®è­¦æŠ¥æ•°é‡é€‰æ‹©æ˜¾ç¤ºç­–ç•¥
            if (newAlerts.length === 1) {
                // å•ä¸ªè­¦æŠ¥ç›´æ¥æ˜¾ç¤º
                this.showSingleAlert(newAlerts[0]);
            } else if (newAlerts.length <= this.batchConfig.maxSingleAlerts) {
                // å°‘é‡è­¦æŠ¥é€ä¸ªæ˜¾ç¤ºï¼Œä½†æœ‰å»¶è¿Ÿ
                this.showSequentialAlerts(newAlerts);
            } else {
                // å¤§é‡è­¦æŠ¥åˆå¹¶æ˜¾ç¤º
                this.showBatchAlert(newAlerts);
            }
        },
        
        // æ˜¾ç¤ºå•ä¸ªè­¦æŠ¥
        showSingleAlert(alert) {
            const popupOptions = this.getAlertOptions(alert);
            this.showCustomPopup(popupOptions);
            
            // å±é™©è­¦æŠ¥æ’­æ”¾å£°éŸ³
            if (alert.level === 'danger') {
                this.playAlertSound();
            }
        },
        
        // é¡ºåºæ˜¾ç¤ºå¤šä¸ªè­¦æŠ¥ï¼ˆå¸¦å»¶è¿Ÿï¼‰
        showSequentialAlerts(alerts) {
            // æŒ‰ä¼˜å…ˆçº§æ’åº
            const sortedAlerts = this.sortAlertsByPriority(alerts);
            
            sortedAlerts.forEach((alert, index) => {
                setTimeout(() => {
                    this.showSingleAlert(alert);
                }, index * 1000); // æ¯ä¸ªè­¦æŠ¥é—´éš”1ç§’
            });
        },
        
        // æ‰¹é‡æ˜¾ç¤ºè­¦æŠ¥ï¼ˆåˆå¹¶åœ¨ä¸€ä¸ªå¼¹çª—ä¸­ï¼‰
        showBatchAlert(alerts) {
            // æŒ‰ä¼˜å…ˆçº§åˆ†ç»„
            const groupedAlerts = this.groupAlertsByLevel(alerts);
            const sortedAlerts = this.sortAlertsByPriority(alerts);
            
            // ç»Ÿè®¡ä¿¡æ¯
            const stats = {
                danger: groupedAlerts.danger?.length || 0,
                warning: groupedAlerts.warning?.length || 0,
                info: groupedAlerts.info?.length || 0,
                total: alerts.length
            };
            
            // ç¡®å®šæœ€é«˜ä¼˜å…ˆçº§
            const highestLevel = stats.danger > 0 ? 'danger' : 
                            stats.warning > 0 ? 'warning' : 'info';
            
            // åˆ›å»ºæ‰¹é‡å¼¹çª—
            this.showBatchPopup(sortedAlerts, stats, highestLevel);
            
            // å¦‚æœ‰å±é™©è­¦æŠ¥ï¼Œæ’­æ”¾å£°éŸ³
            if (stats.danger > 0) {
                this.playAlertSound();
            }
        },
        
        // åˆ›å»ºæ‰¹é‡è­¦æŠ¥å¼¹çª—
        showBatchPopup(alerts, stats, level) {
            try {
                const popup = document.createElement('div');
                popup.style.cssText = `
                    position: fixed;
                    z-index: 9999;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    min-width: 400px;
                    max-width: 600px;
                    max-height: 70vh;
                    overflow-y: auto;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                `;
                
                // æ ¹æ®æœ€é«˜ä¼˜å…ˆçº§è®¾ç½®æ ·å¼
                const styles = this.getBatchPopupStyles(level);
                popup.style.backgroundColor = styles.bgColor;
                popup.style.borderLeft = styles.borderLeft;
                popup.style.color = styles.textColor;
                
                // æ„å»ºå†…å®¹
                let content = `
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 10px;">
                        <div>
                            <h3 style="margin: 0; font-size: 18px;">
                                ${this.getBatchTitle(stats, level)}
                            </h3>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                                ${this.getBatchSummary(stats)}
                            </div>
                        </div>
                        <button id="closeBatchPopup" style="background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.6; margin-left: 20px;">&times;</button>
                    </div>
                    
                    <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                // æ·»åŠ è­¦æŠ¥åˆ—è¡¨
                alerts.slice(0, 10).forEach((alert, index) => {
                    const alertStyles = this.getAlertItemStyles(alert.level);
                    content += `
                        <div style="margin-bottom: 8px; padding: 10px; border-radius: 4px; font-size: 14px; ${alertStyles}">
                            <div style="font-weight: bold; margin-bottom: 4px;">
                                ${this.getAlertIcon(alert.level)} ${alert.type}
                            </div>
                            <div>${alert.message}</div>
                            <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">${alert.timestamp}</div>
                        </div>
                    `;
                });
                
                // å¦‚æœè­¦æŠ¥å¤ªå¤šï¼Œæ˜¾ç¤ºçœç•¥ä¿¡æ¯
                if (alerts.length > 10) {
                    content += `
                        <div style="text-align: center; padding: 10px; font-style: italic; opacity: 0.8;">
                            ... è¿˜æœ‰ ${alerts.length - 10} æ¡è­¦æŠ¥æœªæ˜¾ç¤º
                        </div>
                    `;
                }
                
                content += `
                    </div>
                    
                    <div style="text-align: right; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                        <button id="viewAllAlerts" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                            æŸ¥çœ‹æ‰€æœ‰è­¦æŠ¥
                        </button>
                        <button id="confirmBatchPopup" style="padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            æˆ‘å·²çŸ¥æ™“
                        </button>
                    </div>
                `;
                
                popup.innerHTML = content;
                
                // æ·»åŠ é®ç½©å±‚
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                    z-index: 9998;
                `;
                
                // æ·»åŠ åˆ°DOM
                document.body.appendChild(overlay);
                document.body.appendChild(popup);
                
                // ç»‘å®šäº‹ä»¶
                const closeHandler = () => {
                    document.body.removeChild(popup);
                    document.body.removeChild(overlay);
                };
                
                document.getElementById('closeBatchPopup').addEventListener('click', closeHandler);
                document.getElementById('confirmBatchPopup').addEventListener('click', closeHandler);
                
                // æŸ¥çœ‹æ‰€æœ‰è­¦æŠ¥æŒ‰é’®
                document.getElementById('viewAllAlerts').addEventListener('click', () => {
                    closeHandler();
                    // è¿™é‡Œå¯ä»¥è§¦å‘æ˜¾ç¤ºè­¦æŠ¥è¯¦æƒ…é¡µé¢çš„äº‹ä»¶
                    this.showAllAlertsDetail(alerts);
                });
                
                // ç‚¹å‡»é®ç½©å±‚å…³é—­
                overlay.addEventListener('click', closeHandler);
                
            } catch (e) {
                console.error('åˆ›å»ºæ‰¹é‡è­¦æŠ¥å¼¹çª—å¤±è´¥:', e);
            }
        },
        
        // è·å–è­¦æŠ¥é€‰é¡¹é…ç½®
        getAlertOptions(alert) {
            switch(alert.level) {
                case 'danger':
                    return {
                        icon: 'error',
                        title: `ä¸¥é‡è­¦æŠ¥ï¼š${alert.type}`,
                        text: alert.message,
                        confirmButtonText: 'æˆ‘å·²äº†è§£',
                        confirmButtonColor: '#dc3545',
                        timer: 0,
                    };
                case 'warning':
                    return {
                        icon: 'warning',
                        title: `è­¦å‘Šï¼š${alert.type}`,
                        text: alert.message,
                        confirmButtonText: 'ç¡®è®¤',
                        confirmButtonColor: '#ffc107',
                        timer: 120000,
                    };
                default:
                    return {
                        icon: 'info',
                        title: `æç¤ºï¼š${alert.type}`,
                        text: alert.message,
                        timer: 60000,
                    };
            }
        },
        
        // æŒ‰ä¼˜å…ˆçº§æ’åºè­¦æŠ¥
        sortAlertsByPriority(alerts) {
            return alerts.sort((a, b) => {
                const priorityA = this.batchConfig.priorityLevels[a.level] || 0;
                const priorityB = this.batchConfig.priorityLevels[b.level] || 0;
                return priorityB - priorityA; // é™åºæ’åˆ—
            });
        },
        
        // æŒ‰çº§åˆ«åˆ†ç»„è­¦æŠ¥
        groupAlertsByLevel(alerts) {
            return alerts.reduce((groups, alert) => {
                const level = alert.level || 'info';
                if (!groups[level]) groups[level] = [];
                groups[level].push(alert);
                return groups;
            }, {});
        },
        
        // è·å–æ‰¹é‡å¼¹çª—æ ·å¼
        getBatchPopupStyles(level) {
            switch(level) {
                case 'danger':
                    return {
                        bgColor: '#f8d7da',
                        borderLeft: '5px solid #dc3545',
                        textColor: '#721c24'
                    };
                case 'warning':
                    return {
                        bgColor: '#fff3cd',
                        borderLeft: '5px solid #ffc107',
                        textColor: '#856404'
                    };
                default:
                    return {
                        bgColor: '#d1ecf1',
                        borderLeft: '5px solid #17a2b8',
                        textColor: '#0c5460'
                    };
            }
        },
        
        // è·å–è­¦æŠ¥é¡¹æ ·å¼
        getAlertItemStyles(level) {
            switch(level) {
                case 'danger':
                    return 'background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545;';
                case 'warning':
                    return 'background-color: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107;';
                default:
                    return 'background-color: rgba(23, 162, 184, 0.1); border-left: 3px solid #17a2b8;';
            }
        },
        
        // è·å–è­¦æŠ¥å›¾æ ‡
        getAlertIcon(level) {
            switch(level) {
                case 'danger': return 'ğŸš¨';
                case 'warning': return 'âš ï¸';
                default: return 'â„¹ï¸';
            }
        },
        
        // è·å–æ‰¹é‡æ ‡é¢˜
        getBatchTitle(stats, level) {
            if (stats.danger > 0) {
                return `âš ï¸ å‘ç° ${stats.total} æ¡é‡è¦è­¦æŠ¥`;
            } else if (stats.warning > 0) {
                return `ğŸ“‹ æ”¶åˆ° ${stats.total} æ¡ç³»ç»Ÿè­¦æŠ¥`;
            } else {
                return `ğŸ“ ${stats.total} æ¡ç³»ç»Ÿæé†’`;
            }
        },
        
        // è·å–æ‰¹é‡æ‘˜è¦
        getBatchSummary(stats) {
            let summary = [];
            if (stats.danger > 0) summary.push(`${stats.danger}æ¡ä¸¥é‡è­¦æŠ¥`);
            if (stats.warning > 0) summary.push(`${stats.warning}æ¡è­¦å‘Š`);
            if (stats.info > 0) summary.push(`${stats.info}æ¡æé†’`);
            return summary.join(' Â· ');
        },
        
        // æ˜¾ç¤ºæ‰€æœ‰è­¦æŠ¥è¯¦æƒ…ï¼ˆå¯ä»¥è·³è½¬åˆ°è­¦æŠ¥é¡µé¢æˆ–å±•å¼€è¯¦æƒ…ï¼‰
        showAllAlertsDetail(alerts) {
            console.log('æ˜¾ç¤ºæ‰€æœ‰è­¦æŠ¥è¯¦æƒ…:', alerts);
        },
        
        // åˆ›å»ºè‡ªå®šä¹‰å¼¹çª—
        showCustomPopup(options) {
            try {
                // åˆ›å»ºå¼¹çª—å…ƒç´ 
                const popup = document.createElement('div');
                popup.style.position = 'fixed';
                popup.style.zIndex = '9999';
                popup.style.top = '20px';
                popup.style.right = '20px';
                popup.style.padding = '15px 20px';
                popup.style.borderRadius = '5px';
                popup.style.boxShadow = '0 3px 10px rgba(0,0,0,0.2)';
                popup.style.minWidth = '280px';
                popup.style.maxWidth = '450px';
                
                // æ ¹æ®è­¦æŠ¥çº§åˆ«è®¾ç½®æ ·å¼
                if (options.icon === 'error') {
                    popup.style.backgroundColor = '#f8d7da';
                    popup.style.borderLeft = '5px solid #dc3545';
                    popup.style.color = '#721c24';
                } else if (options.icon === 'warning') {
                    popup.style.backgroundColor = '#fff3cd';
                    popup.style.borderLeft = '5px solid #ffc107';
                    popup.style.color = '#856404';
                } else {
                    popup.style.backgroundColor = '#d1ecf1';
                    popup.style.borderLeft = '5px solid #17a2b8';
                    popup.style.color = '#0c5460';
                }
                
                // æ·»åŠ å†…å®¹
                popup.innerHTML = `
                    <div style="margin-bottom: 10px; font-weight: bold; font-size: 16px;">
                        ${options.title || 'è­¦æŠ¥'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        ${options.text || ''}
                    </div>
                    <div style="text-align: right;">
                        <button id="closePopup" style="padding: 5px 12px; background-color: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            å…³é—­
                        </button>
                    </div>
                `;
                
                // æ·»åŠ åˆ°DOM
                document.body.appendChild(popup);
                
                // æ·»åŠ å…³é—­æŒ‰é’®åŠŸèƒ½
                document.getElementById('closePopup').addEventListener('click', function() {
                    document.body.removeChild(popup);
                });
                
                // å¦‚æœè®¾ç½®äº†timerï¼Œæ·»åŠ è‡ªåŠ¨å…³é—­åŠŸèƒ½
                if (options.timer) {
                    setTimeout(() => {
                        if (document.body.contains(popup)) {
                            document.body.removeChild(popup);
                        }
                    }, options.timer);
                }
            } catch (e) {
                console.error('åˆ›å»ºè‡ªå®šä¹‰å¼¹çª—å¤±è´¥:', e);
            }
        },
        
        playAlertSound() {
            try {
                const audio = new Audio('/assets/sounds/alert.mp3');
                audio.play();
            } catch (e) {
                console.error('æ— æ³•æ’­æ”¾è­¦æŠ¥å£°éŸ³:', e);
            }
        },
        
        clearShownAlerts() {
            this.shownAlerts.clear();
        }
    };

/*
    * æ°´è´¨è­¦æŠ¥å¤„ç†
*/

    // å…¨å±€æ°´è´¨æ•°æ®å­˜å‚¨
    let globalWaterQualityData = {};

    // æ°´è´¨å¼‚å¸¸æ£€æµ‹è§„åˆ™
    const waterQualityAlertRules = {
        // ä¸¥é‡æ±¡æŸ“ - å±é™©çº§åˆ« (åŠ£Vç±»)
        severePollution: {
            conditions: [
                { parameter: 'dissolvedOxygen', threshold: 2, operator: '<', unit: 'mg/L' },
                { parameter: 'cod', threshold: 40, operator: '>', unit: 'mg/L' },
                { parameter: 'ammoniaNitrogen', threshold: 2.0, operator: '>', unit: 'mg/L' },
                { parameter: 'totalPhosphorus', threshold: 0.4, operator: '>', unit: 'mg/L' },
                { parameter: 'totalNitrogen', threshold: 2.0, operator: '>', unit: 'mg/L' }
            ],
            level: 'danger',
            type: 'ä¸¥é‡æ±¡æŸ“',
            getMessage: (data, param) => {
                if (param === 'dissolvedOxygen') {
                    return `ä¸¥é‡ç¼ºæ°§è­¦å‘Šï¼æº¶è§£æ°§æµ“åº¦${data.dissolvedOxygen}mg/Lï¼Œæ°´ä½“ä¸¥é‡ç¼ºæ°§ï¼Œæ°´ç”Ÿç”Ÿç‰©é¢ä¸´æ­»äº¡é£é™©ï¼`;
                } else if (param === 'cod') {
                    return `æœ‰æœºæ±¡æŸ“ä¸¥é‡ï¼åŒ–å­¦éœ€æ°§é‡${data.cod}mg/Lï¼Œæ°´ä½“æœ‰æœºæ±¡æŸ“ä¸¥é‡è¶…æ ‡ï¼`;
                } else if (param === 'ammoniaNitrogen') {
                    return `æ°¨æ°®ä¸¥é‡è¶…æ ‡ï¼æµ“åº¦${data.ammoniaNitrogen}mg/Lï¼Œå¯èƒ½å¯¼è‡´æ°´ä½“å¯Œè¥å…»åŒ–ï¼`;
                } else if (param === 'totalPhosphorus') {
                    return `æ€»ç£·ä¸¥é‡è¶…æ ‡ï¼æµ“åº¦${data.totalPhosphorus}mg/Lï¼Œæ°´ä½“å¯Œè¥å…»åŒ–ä¸¥é‡ï¼`;
                } else if (param === 'totalNitrogen') {
                    return `æ€»æ°®ä¸¥é‡è¶…æ ‡ï¼æµ“åº¦${data.totalNitrogen}mg/Lï¼Œæ°´ä½“è¥å…»ç›ä¸¥é‡è¿‡é‡ï¼`;
                }
            }
        },
        // é‡åº¦æ±¡æŸ“ - è­¦å‘Šçº§åˆ« (Vç±»æ°´è´¨)
        heavyPollution: {
            conditions: [
                { parameter: 'dissolvedOxygen', threshold: 3, operator: '<', unit: 'mg/L' },
                { parameter: 'dissolvedOxygen', threshold: 2, operator: '>=', unit: 'mg/L' },
                { parameter: 'cod', threshold: 30, operator: '>', unit: 'mg/L' },
                { parameter: 'cod', threshold: 40, operator: '<=', unit: 'mg/L' },
                { parameter: 'ammoniaNitrogen', threshold: 1.5, operator: '>', unit: 'mg/L' },
                { parameter: 'ammoniaNitrogen', threshold: 2.0, operator: '<=', unit: 'mg/L' },
                { parameter: 'totalPhosphorus', threshold: 0.2, operator: '>', unit: 'mg/L' },
                { parameter: 'totalPhosphorus', threshold: 0.4, operator: '<=', unit: 'mg/L' }
            ],
            level: 'warning',
            type: 'é‡åº¦æ±¡æŸ“',
            getMessage: (data, param) => {
                if (param === 'dissolvedOxygen') {
                    return `æº¶è§£æ°§åä½è­¦å‘Šï¼šå½“å‰${data.dissolvedOxygen}mg/Lï¼Œæ°´ä½“å¼€å§‹ç¼ºæ°§ã€‚`;
                } else if (param === 'cod') {
                    return `åŒ–å­¦éœ€æ°§é‡è¶…æ ‡è­¦å‘Šï¼šå½“å‰${data.cod}mg/Lï¼Œæ°´ä½“æœ‰æœºæ±¡æŸ“è¾ƒé‡ã€‚`;
                } else if (param === 'ammoniaNitrogen') {
                    return `æ°¨æ°®è¶…æ ‡è­¦å‘Šï¼šæµ“åº¦${data.ammoniaNitrogen}mg/Lï¼Œæ°´ä½“æ±¡æŸ“åŠ é‡ã€‚`;
                } else if (param === 'totalPhosphorus') {
                    return `æ€»ç£·è¶…æ ‡è­¦å‘Šï¼šæµ“åº¦${data.totalPhosphorus}mg/Lï¼Œå¯èƒ½å¼•èµ·æ°´ä½“å¯Œè¥å…»åŒ–ã€‚`;
                }
            }
        },
        // ä¸­åº¦æ±¡æŸ“ - æ³¨æ„çº§åˆ« (IVç±»æ°´è´¨)
        moderatePollution: {
            conditions: [
                { parameter: 'dissolvedOxygen', threshold: 5, operator: '<', unit: 'mg/L' },
                { parameter: 'dissolvedOxygen', threshold: 3, operator: '>=', unit: 'mg/L' },
                { parameter: 'cod', threshold: 20, operator: '>', unit: 'mg/L' },
                { parameter: 'cod', threshold: 30, operator: '<=', unit: 'mg/L' },
                { parameter: 'ammoniaNitrogen', threshold: 1.0, operator: '>', unit: 'mg/L' },
                { parameter: 'ammoniaNitrogen', threshold: 1.5, operator: '<=', unit: 'mg/L' },
                { parameter: 'totalPhosphorus', threshold: 0.1, operator: '>', unit: 'mg/L' },
                { parameter: 'totalPhosphorus', threshold: 0.2, operator: '<=', unit: 'mg/L' },
                { parameter: 'conductivity', threshold: 1000, operator: '>', unit: 'Î¼S/cm' },
                { parameter: 'turbidity', threshold: 5, operator: '>', unit: 'NTU' }
            ],
            level: 'info',
            type: 'ä¸­åº¦æ±¡æŸ“',
            getMessage: (data, param) => {
                if (param === 'dissolvedOxygen') {
                    return `æº¶è§£æ°§åä½æé†’ï¼šå½“å‰${data.dissolvedOxygen}mg/Lï¼Œå»ºè®®å…³æ³¨æ°´ä½“å«æ°§é‡ã€‚`;
                } else if (param === 'cod') {
                    return `åŒ–å­¦éœ€æ°§é‡åé«˜ï¼šå½“å‰${data.cod}mg/Lï¼Œæ°´ä½“æœ‰æœºç‰©å«é‡è¾ƒé«˜ã€‚`;
                } else if (param === 'ammoniaNitrogen') {
                    return `æ°¨æ°®åé«˜æé†’ï¼šæµ“åº¦${data.ammoniaNitrogen}mg/Lï¼Œæ°´è´¨å¼€å§‹ä¸‹é™ã€‚`;
                } else if (param === 'totalPhosphorus') {
                    return `æ€»ç£·åé«˜æé†’ï¼šæµ“åº¦${data.totalPhosphorus}mg/Lï¼Œéœ€è¦å…³æ³¨ã€‚`;
                } else if (param === 'conductivity') {
                    return `ç”µå¯¼ç‡åé«˜ï¼šå½“å‰${data.conductivity}Î¼S/cmï¼Œæ°´ä½“çŸ¿åŒ–åº¦è¾ƒé«˜ã€‚`;
                } else if (param === 'turbidity') {
                    return `æµŠåº¦åé«˜æé†’ï¼šå½“å‰${data.turbidity}NTUï¼Œæ°´ä½“é€æ˜åº¦ä¸‹é™ã€‚`;
                }
            }
        },
        // pHå¼‚å¸¸
        pHAnomaly: {
            highPH: 9,
            lowPH: 6,
            level: 'warning',
            type: 'pHå¼‚å¸¸',
            getMessage: (data) => {
                if (data.pH > 9) {
                    return `pHå€¼è¿‡é«˜è­¦å‘Šï¼šå½“å‰pH=${data.pH}ï¼Œæ°´ä½“å‘ˆå¼ºç¢±æ€§ï¼Œå¯èƒ½å½±å“æ°´ç”Ÿç”Ÿç‰©ç”Ÿå­˜ã€‚`;
                } else if (data.pH < 6) {
                    return `pHå€¼è¿‡ä½è­¦å‘Šï¼šå½“å‰pH=${data.pH}ï¼Œæ°´ä½“å‘ˆé…¸æ€§ï¼Œå¯èƒ½è…èš€æ€§è¾ƒå¼ºã€‚`;
                }
                return null;
            }
        },
        // æ¸©åº¦å¼‚å¸¸
        temperatureAnomaly: {
            highTemp: 35, // é«˜æ¸©é˜ˆå€¼
            lowTemp: 0,   // ä½æ¸©é˜ˆå€¼
            level: 'info',
            type: 'æ°´æ¸©å¼‚å¸¸',
            getMessage: (data) => {
                if (data.waterTemp > 35) {
                    return `æ°´æ¸©è¿‡é«˜æé†’ï¼šå½“å‰æ°´æ¸©${data.waterTemp}Â°Cï¼Œå¯èƒ½å½±å“æ°´ä½“æº¶æ°§èƒ½åŠ›ã€‚`;
                } else if (data.waterTemp < 0) {
                    return `æ°´æ¸©è¿‡ä½æé†’ï¼šå½“å‰æ°´æ¸©${data.waterTemp}Â°Cï¼Œæ°´ä½“å¯èƒ½ç»“å†°ã€‚`;
                }
                return null;
            }
        }
    };

    // æ£€æµ‹æ°´è´¨å¼‚å¸¸
    function detectWaterQualityAnomalies(waterData) {
        const alerts = [];
        
        // æ£€æŸ¥ä¸¥é‡æ±¡æŸ“
        waterQualityAlertRules.severePollution.conditions.forEach(condition => {
            const value = waterData[condition.parameter];
            if (value !== undefined && checkCondition(value, condition.threshold, condition.operator)) {
                alerts.push({
                    level: waterQualityAlertRules.severePollution.level,
                    type: waterQualityAlertRules.severePollution.type,
                    message: waterQualityAlertRules.severePollution.getMessage(waterData, condition.parameter),
                    timestamp: new Date().toISOString()
                });
            }
        });

        // æ£€æŸ¥é‡åº¦æ±¡æŸ“
        waterQualityAlertRules.heavyPollution.conditions.forEach(condition => {
            const value = waterData[condition.parameter];
            if (value !== undefined && checkCondition(value, condition.threshold, condition.operator)) {
                alerts.push({
                    level: waterQualityAlertRules.heavyPollution.level,
                    type: waterQualityAlertRules.heavyPollution.type,
                    message: waterQualityAlertRules.heavyPollution.getMessage(waterData, condition.parameter),
                    timestamp: new Date().toISOString()
                });
            }
        });

        // æ£€æŸ¥ä¸­åº¦æ±¡æŸ“
        waterQualityAlertRules.moderatePollution.conditions.forEach(condition => {
            const value = waterData[condition.parameter];
            if (value !== undefined && checkCondition(value, condition.threshold, condition.operator)) {
                alerts.push({
                    level: waterQualityAlertRules.moderatePollution.level,
                    type: waterQualityAlertRules.moderatePollution.type,
                    message: waterQualityAlertRules.moderatePollution.getMessage(waterData, condition.parameter),
                    timestamp: new Date().toISOString()
                });
            }
        });

        // æ£€æŸ¥pHå¼‚å¸¸
        if (waterData.pH > waterQualityAlertRules.pHAnomaly.highPH || 
            waterData.pH < waterQualityAlertRules.pHAnomaly.lowPH) {
            const pHMessage = waterQualityAlertRules.pHAnomaly.getMessage(waterData);
            
            if (pHMessage) {
                alerts.push({
                    level: waterQualityAlertRules.pHAnomaly.level,
                    type: waterQualityAlertRules.pHAnomaly.type,
                    message: pHMessage,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // æ£€æŸ¥æ¸©åº¦å¼‚å¸¸
        if (waterData.waterTemp > waterQualityAlertRules.temperatureAnomaly.highTemp || 
            waterData.waterTemp < waterQualityAlertRules.temperatureAnomaly.lowTemp) {
            const tempMessage = waterQualityAlertRules.temperatureAnomaly.getMessage(waterData);
            
            if (tempMessage) {
                alerts.push({
                    level: waterQualityAlertRules.temperatureAnomaly.level,
                    type: waterQualityAlertRules.temperatureAnomaly.type,
                    message: tempMessage,
                    timestamp: new Date().toISOString()
                });
            }
        }

        return alerts;
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ¡ä»¶
    function checkCondition(value, threshold, operator) {
        switch (operator) {
            case '>':
                return value > threshold;
            case '<':
                return value < threshold;
            case '>=':
                return value >= threshold;
            case '<=':
                return value <= threshold;
            case '==':
                return value == threshold;
            default:
                return false;
        }
    }

    // æµ·æ´‹ç‰§åœºä¸æ°´è´¨ç›‘æµ‹ç‚¹çš„æ˜ å°„é…ç½®
    const marineRanchWaterQualityMapping = {
        'å±±ä¸œé’å²›': {
            files: ['../static/water_quality/å±±ä¸œçœ/é»„æ²³æµåŸŸ/ç‹å°å¤§æ¡¥(æµæ³½æ¡¥)/2021-04/ç‹å°å¤§æ¡¥(æµæ³½æ¡¥).csv', 
            '../static/water_quality/å±±ä¸œçœ/é»„æ²³æµåŸŸ/è´ºå°åº„/2021-04/è´ºå°åº„.csv'],
            priority: 0 // ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€ä¸ªç›‘æµ‹ç‚¹
        },
        'æµ™æ±ŸèˆŸå±±': {
            files: ['../static/water_quality/æµ™æ±Ÿçœ/å¤ªæ¹–æµåŸŸ/æ–°å¡˜/2021-04/æ–°å¡˜.csv', 
            '../static/water_quality/æµ™æ±Ÿçœ/å¤ªæ¹–æµåŸŸ/åŸè¥¿å¤§æ¡¥/2021-04/åŸè¥¿å¤§æ¡¥.csv'], 
            priority: 0
        },
        'ç¦å»ºå¦é—¨': {
            files: ['../static/water_quality/ç¦å»ºçœ/æµ™é—½ç‰‡æ²³æµ/æ±Ÿå£æ¡¥/2021-04/æ±Ÿå£æ¡¥.csv'],
            priority: 0
        },
        'å¹¿ä¸œæ¹›æ±Ÿ': {
            files: ['../static/water_quality/å¹¿ä¸œçœ/ç æ±ŸæµåŸŸ/èµ¤åæ°´å‚(å¡˜å£å–æ°´å£)/2021-04/èµ¤åæ°´å‚(å¡˜å£å–æ°´å£).csv'],
            priority: 0
        },
        'è¾½å®å¤§è¿': {
            files: ['../static/water_quality/è¾½å®çœ/è¾½æ²³æµåŸŸ/ä¸‰å°å­/2021-04/ä¸‰å°å­.csv', 
            '../static/water_quality/è¾½å®çœ/è¾½æ²³æµåŸŸ/çº¢çŸ³ç¢‘å…¥æµ·å‰/2021-04/çº¢çŸ³ç¢‘å…¥æµ·å‰.csv', 
            '../static/water_quality/è¾½å®çœ/è¾½æ²³æµåŸŸ/è’²çŸ³æ²³å¤§æ¡¥/2021-04/è’²çŸ³æ²³å¤§æ¡¥.csv'],
            priority: 0
        },
        'æ²³åŒ—ç§¦çš‡å²›': {
            files: ['../static/water_quality/æ²³åŒ—çœ/æµ·æ²³æµåŸŸ/æˆ´æ²³å£/2021-04/æˆ´æ²³å£.csv', 
            '../static/water_quality/æ²³åŒ—çœ/æµ·æ²³æµåŸŸ/æ±¤æ²³å£/2021-04/æ±¤æ²³å£.csv', 
            '../static/water_quality/æ²³åŒ—çœ/æµ·æ²³æµåŸŸ/æ´‹æ²³å£/2021-04/æ´‹æ²³å£.csv'],
            priority: 0
        }
    };

    // ä»CSVæ–‡ä»¶åŠ è½½æ°´è´¨æ•°æ®
    async function loadWaterQualityFromCSV(ranchName) {
        try {
            const mapping = marineRanchWaterQualityMapping[ranchName];
            if (!mapping) {
                console.warn(`æœªæ‰¾åˆ°æµ·æ´‹ç‰§åœº ${ranchName} çš„æ°´è´¨æ•°æ®æ˜ å°„é…ç½®`);
                return null;
            }

            // å°è¯•åŠ è½½æ‰€æœ‰å…³è”çš„CSVæ–‡ä»¶ï¼Œå–ç¬¬ä¸€ä¸ªæˆåŠŸçš„
            let waterQualityData = null;
            let loadedFromFile = null;

            // ä¼˜å…ˆåŠ è½½ä¸»è¦ç›‘æµ‹ç‚¹çš„æ•°æ®
            const priorityFile = mapping.files[mapping.priority];
            try {
                waterQualityData = await loadSingleWaterQualityCSV(priorityFile);
                if (waterQualityData) {
                    loadedFromFile = priorityFile;
                    console.log(`ä»ä¸»è¦ç›‘æµ‹ç‚¹åŠ è½½æ°´è´¨æ•°æ®: ${priorityFile}`);
                }
            } catch (error) {
                console.warn(`åŠ è½½ä¸»è¦ç›‘æµ‹ç‚¹æ•°æ®å¤±è´¥ (${priorityFile}):`, error.message);
            }

            // å¦‚æœä¸»è¦ç›‘æµ‹ç‚¹æ•°æ®åŠ è½½å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç›‘æµ‹ç‚¹
            if (!waterQualityData) {
                for (const filePath of mapping.files) {
                    if (filePath === priorityFile) continue; // è·³è¿‡å·²å°è¯•çš„ä¸»è¦ç›‘æµ‹ç‚¹

                    try {
                        waterQualityData = await loadSingleWaterQualityCSV(filePath);
                        if (waterQualityData) {
                            loadedFromFile = filePath;
                            console.log(`ä»å¤‡ç”¨ç›‘æµ‹ç‚¹åŠ è½½æ°´è´¨æ•°æ®: ${filePath}`);
                            break;
                        }
                    } catch (error) {
                        console.warn(`åŠ è½½å¤‡ç”¨ç›‘æµ‹ç‚¹æ•°æ®å¤±è´¥ (${filePath}):`, error.message);
                    }
                }
            }

            if (waterQualityData) {
                // æ·»åŠ æµ·æ´‹ç‰§åœºä¿¡æ¯å’Œæ•°æ®æºä¿¡æ¯
                waterQualityData.ranchName = ranchName;
                waterQualityData.dataSource = loadedFromFile;
                waterQualityData.allSources = mapping.files;
                return waterQualityData;
            } else {
                console.error(`æ‰€æœ‰ç›‘æµ‹ç‚¹æ•°æ®åŠ è½½å¤±è´¥: ${ranchName}`);
                return null;
            }
            
        } catch (error) {
            console.error(`åŠ è½½æ°´è´¨æ•°æ®å¤±è´¥ (${ranchName}):`, error);
            return null;
        }
    }

    // åŠ è½½å•ä¸ªCSVæ–‡ä»¶çš„æ°´è´¨æ•°æ®
    async function loadSingleWaterQualityCSV(filePath) {
        const response = await fetch(filePath);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const csvText = await response.text();
        const lines = csvText.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
            throw new Error('CSVæ–‡ä»¶æ— æœ‰æ•ˆæ•°æ®è¡Œ');
        }
        
        // è§£æè¡¨å¤´
        const headers = lines[0].split(',').map(h => h.trim());
        
        // è§£ææœ€æ–°çš„ä¸€è¡Œæ•°æ®ï¼ˆå‡è®¾æœ€åä¸€è¡Œæ˜¯æœ€æ–°æ•°æ®ï¼‰
        const latestDataLine = lines[lines.length - 1].trim();
        if (!latestDataLine) {
            throw new Error('æœ€æ–°æ•°æ®è¡Œä¸ºç©º');
        }
        
        const values = latestDataLine.split(',').map(v => v.trim());
        
        // éªŒè¯æ•°æ®å®Œæ•´æ€§ - æ ¹æ®æ–°æ ¼å¼è°ƒæ•´ä¸º17åˆ—
        if (values.length < 17) {
            throw new Error(`æ•°æ®åˆ—æ•°ä¸è¶³ï¼ŒæœŸæœ›17åˆ—ï¼Œå®é™…${values.length}åˆ—`);
        }
        
        // è§£æç›‘æµ‹æ—¶é—´ï¼ˆæ ¼å¼ï¼š04-01 04:00ï¼‰
        const monitoringTime = values[3];
        let timestamp;
        try {
            // å‡è®¾æ˜¯å½“å‰å¹´ä»½ï¼Œå°† "04-01 04:00" è½¬æ¢ä¸ºå®Œæ•´æ—¥æœŸ
            const currentYear = new Date().getFullYear();
            const [dateStr, timeStr] = monitoringTime.split(' ');
            const [month, day] = dateStr.split('-');
            const [hour, minute] = timeStr.split(':');
            timestamp = new Date(currentYear, parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute)).toISOString();
        } catch (error) {
            timestamp = new Date().toISOString();
            console.warn('ç›‘æµ‹æ—¶é—´è§£æå¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´:', error);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è§£ææ•°å€¼ï¼Œå¤„ç† '*' ç­‰ç‰¹æ®Šå€¼
        function parseNumericValue(value, defaultValue = 0) {
            if (value === '*' || value === '' || value === undefined) {
                return null; // ç”¨ null è¡¨ç¤ºæ— æ•ˆæ•°æ®
            }
            const parsed = parseFloat(value);
            return isNaN(parsed) ? defaultValue : parsed;
        }
        
        // æ˜ å°„CSVæ•°æ®åˆ°æ°´è´¨ç›‘æµ‹å‚æ•°ï¼ˆæŒ‰æ–°çš„åˆ—é¡ºåºï¼‰
        const waterQualityData = {
            province: values[0] || 'æœªçŸ¥',              // çœä»½
            watershed: values[1] || 'æœªçŸ¥',             // æµåŸŸ
            location: values[2] || 'æœªçŸ¥',              // æ–­é¢åç§°
            qualityCategory: values[4] || 'æœªçŸ¥',       // æ°´è´¨ç±»åˆ«
            waterTemp: parseNumericValue(values[5]),    // æ°´æ¸©(â„ƒ)
            pH: parseNumericValue(values[6], 7),        // pH(æ— é‡çº²)
            dissolvedOxygen: parseNumericValue(values[7]), // æº¶è§£æ°§(mg/L)
            conductivity: parseNumericValue(values[8]), // ç”µå¯¼ç‡(Î¼S/cm)
            turbidity: parseNumericValue(values[9]),    // æµŠåº¦(NTU)
            cod: parseNumericValue(values[10]),         // é«˜é”°é…¸ç›æŒ‡æ•°(mg/L)
            ammoniaNitrogen: parseNumericValue(values[11]), // æ°¨æ°®(mg/L)
            totalPhosphorus: parseNumericValue(values[12]), // æ€»ç£·(mg/L)
            totalNitrogen: parseNumericValue(values[13]),   // æ€»æ°®(mg/L)
            timestamp: timestamp,                       // æ ‡å‡†åŒ–æ—¶é—´æˆ³
            rawData: values // ä¿å­˜åŸå§‹æ•°æ®ä»¥ä¾›è°ƒè¯•
        };
        
        return waterQualityData;
    }

    // è·å–æ‰€æœ‰æµ·æ´‹ç‰§åœºçš„æ°´è´¨æ•°æ®
    async function fetchMarineRanchWaterQualityData(marineRanches) {
        console.log('å¼€å§‹è·å–æ‰€æœ‰æµ·æ´‹ç‰§åœºçš„æ°´è´¨æ•°æ®...');
        
        const waterQualityDataPromises = marineRanches.map(async (ranch) => {
            try {
                console.log(`æ­£åœ¨åŠ è½½ ${ranch.name} çš„æ°´è´¨æ•°æ®...`);
                const data = await loadWaterQualityFromCSV(ranch.name);
                
                if (data) {
                    // æ·»åŠ æµ·æ´‹ç‰§åœºçš„åŸºæœ¬ä¿¡æ¯
                    return { 
                        ...data, 
                        name: ranch.name,
                        province: ranch.province,
                        city: ranch.city,
                        coordinates: ranch.exactLocation
                    };
                } else {
                    console.warn(`${ranch.name} çš„æ°´è´¨æ•°æ®åŠ è½½å¤±è´¥`);
                    return null;
                }
            } catch (error) {
                console.error(`è·å– ${ranch.name} æ°´è´¨æ•°æ®æ—¶å‡ºé”™:`, error);
                return null;
            }
        });
        
        const results = await Promise.all(waterQualityDataPromises);
        const validResults = results.filter(data => data !== null);
        
        console.log(`æˆåŠŸåŠ è½½ ${validResults.length}/${marineRanches.length} ä¸ªæµ·æ´‹ç‰§åœºçš„æ°´è´¨æ•°æ®`);
        return validResults;
    }

    // è·å–æŒ‡å®šæµ·æ´‹ç‰§åœºçš„æ‰€æœ‰ç›‘æµ‹ç‚¹æ•°æ®
    async function getAllWaterQualityDataForRanch(ranchName) {
        try {
            const mapping = marineRanchWaterQualityMapping[ranchName];
            if (!mapping) {
                console.warn(`æœªæ‰¾åˆ°æµ·æ´‹ç‰§åœº ${ranchName} çš„æ°´è´¨æ•°æ®æ˜ å°„é…ç½®`);
                return [];
            }

            const allDataPromises = mapping.files.map(async (filePath, index) => {
                try {
                    const data = await loadSingleWaterQualityCSV(filePath);
                    return {
                        ...data,
                        monitoringPoint: filePath.split('/').pop().replace('.csv', ''),
                        filePath: filePath,
                        isPrimary: index === mapping.priority
                    };
                } catch (error) {
                    console.warn(`åŠ è½½ç›‘æµ‹ç‚¹æ•°æ®å¤±è´¥ (${filePath}):`, error.message);
                    return null;
                }
            });

            const results = await Promise.all(allDataPromises);
            return results.filter(data => data !== null);

        } catch (error) {
            console.error(`è·å– ${ranchName} æ‰€æœ‰ç›‘æµ‹ç‚¹æ•°æ®å¤±è´¥:`, error);
            return [];
        }
    }

    // æ›´æ–°æ°´è´¨è­¦æŠ¥
    async function updateWaterQualityAlerts(selectedRanchIndex) {
        const waterQualityData = Object.values(globalWaterQualityData);
        
        if (selectedRanchIndex !== null && selectedRanchIndex !== '') {
            const selectedRanch = marineRanches[selectedRanchIndex];
            const ranchWaterQuality = waterQualityData.find(w => w.name === selectedRanch.name);
            
            if (ranchWaterQuality) {
                // æ£€æµ‹æ°´è´¨å¼‚å¸¸
                const waterQualityAlerts = detectWaterQualityAnomalies(ranchWaterQuality);
                
                // è·å–ä¸Šä¸€æ¬¡çš„è­¦æŠ¥
                let previousAlerts = [];
                try {
                    previousAlerts = await csvOperations.loadAlertsFromCSV(selectedRanch.name);
                } catch (error) {
                    console.error("è·å–å†å²æ°´è´¨è­¦æŠ¥å¤±è´¥:", error);
                }
                
                // å°†æ°´è´¨è­¦æŠ¥æ›´æ–°åˆ°CSVæ–‡ä»¶
                const allAlerts = await csvOperations.updateAlertsInCSV(selectedRanch.name, waterQualityAlerts);
                
                // è¯†åˆ«æ–°çš„è­¦æŠ¥ï¼ˆå½“å‰æ£€æµ‹åˆ°ä½†ä¸åœ¨å†å²è®°å½•ä¸­çš„è­¦æŠ¥ï¼‰
                const newAlerts = waterQualityAlerts.filter(alert => {
                    // æ£€æŸ¥å†å²è®°å½•ä¸­æ˜¯å¦å·²æœ‰åŒç±»å‹çš„è­¦æŠ¥
                    return !previousAlerts.some(prevAlert => 
                        prevAlert.type === alert.type && 
                        prevAlert.level === alert.level && 
                        prevAlert.message === alert.message
                    );
                });
                
                // // ä¸ºæ–°çš„è­¦æŠ¥æ˜¾ç¤ºå¼¹çª—
                // newAlerts.forEach(alert => {
                //     alertPopupSystem.showAlertPopup(alert);
                // });
                alertPopupSystem.showAlerts(newAlerts);
                
                // æ›´æ–°è­¦æŠ¥æ•°é‡
                document.getElementById('alertCount').textContent = `${allAlerts.length}ä¸ª`;
                
                // æ›´æ–°è­¦æŠ¥æ˜¾ç¤º
                const alertsContainer = document.getElementById('alertsContainer');
                alertsContainer.innerHTML = '';
                // å¦‚æœæ²¡æœ‰ä»»ä½•è­¦æŠ¥ï¼Œæ˜¾ç¤ºæ­£å¸¸çŠ¶æ€
                if (allAlerts.length === 0) {
                    alertsContainer.innerHTML = '<div class="alert alert-success">å½“å‰æ— å‘Šè­¦ä¿¡æ¯ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚</div>';
                } else {
                    allAlerts.forEach((alert, index) => {
                        const alertDiv = `
                            <div class="alert alert-${alert.level}">
                                <strong>${alert.type}ï¼š</strong> ${alert.message}
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAlertHandler('${selectedRanch.name}', ${index})">
                                        <i class="fas fa-times"></i> åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                        alertsContainer.innerHTML += alertDiv;
                    });
                }
                
                // // æ›´æ–°æ°´è´¨ä¿¡æ¯æ˜¾ç¤º
                // updateWaterQualityDisplay(ranchWaterQuality);
            }
        }
    }

    // æ›´æ–°æ°´è´¨ä¿¡æ¯æ˜¾ç¤º
    function updateWaterQualityDisplay(waterQualityData) {
        // æ›´æ–°æ°´è´¨çŠ¶æ€æ˜¾ç¤º
        const waterQualityStatusElement = document.getElementById('waterQualityStatus');
        if (waterQualityStatusElement) {
            let statusClass = 'text-success';
            let statusText = 'ä¼˜è‰¯';
            
            // æ ¹æ®æ°´è´¨ç±»åˆ«ç¡®å®šçŠ¶æ€
            switch (waterQualityData.qualityCategory) {
                case 'Iç±»':
                case 'IIç±»':
                    statusClass = 'text-success';
                    statusText = 'ä¼˜è‰¯';
                    break;
                case 'IIIç±»':
                    statusClass = 'text-warning';
                    statusText = 'ä¸€èˆ¬';
                    break;
                case 'IVç±»':
                case 'Vç±»':
                    statusClass = 'text-danger';
                    statusText = 'è¾ƒå·®';
                    break;
                default:
                    statusClass = 'text-muted';
                    statusText = 'æœªçŸ¥';
            }
            
            waterQualityStatusElement.innerHTML = `
                <i class="fas fa-tint ${statusClass}"></i> 
                æ°´è´¨${waterQualityData.qualityCategory} - ${statusText} | 
                æ¸©åº¦: ${waterQualityData.waterTemp}Â°C | 
                pH: ${waterQualityData.pH} | 
                æº¶è§£æ°§: ${waterQualityData.dissolvedOxygen}mg/L
            `;
        }
    }

    // åˆå§‹åŒ–æ°´è´¨ç›‘æµ‹
    async function initWaterQualityMonitoring() {
        try {
            console.log('å¼€å§‹åˆå§‹åŒ–æ°´è´¨ç›‘æµ‹...');
            
            // è·å–åˆå§‹æ°´è´¨æ•°æ®
            const waterQualityData = await fetchMarineRanchWaterQualityData(marineRanches);
            
            // å­˜å‚¨åˆ°å…¨å±€å˜é‡
            waterQualityData.forEach(data => {
                globalWaterQualityData[data.name] = data;
            });

            console.log('å…¨å±€æ°´è´¨æ•°æ®:', globalWaterQualityData);
            
            // å¦‚æœæœ‰é€‰ä¸­çš„ç‰§åœºï¼Œç«‹å³æ›´æ–°è­¦æŠ¥
            const selectedIndex = localStorage.getItem('selectedMarineFarm');
            if (selectedIndex !== null && selectedIndex !== '') {
                await updateWaterQualityAlerts(selectedIndex);
            }
            
            // å®šæœŸæ›´æ–°æ°´è´¨æ•°æ®ï¼ˆæ¯30åˆ†é’Ÿï¼Œå› ä¸ºæ°´è´¨å˜åŒ–ç›¸å¯¹è¾ƒæ…¢ï¼‰
            setInterval(async () => {
                console.log('å®šæœŸæ›´æ–°æ°´è´¨æ•°æ®...');
                const newWaterQualityData = await fetchMarineRanchWaterQualityData(marineRanches);
                newWaterQualityData.forEach(data => {
                    globalWaterQualityData[data.name] = data;
                });
                
                // æ›´æ–°å½“å‰é€‰ä¸­ç‰§åœºçš„è­¦æŠ¥
                const currentIndex = document.getElementById('marineFarmSelect').value;
                if (currentIndex !== '') {
                    await updateWaterQualityAlerts(currentIndex);
                }
            }, 1800000); // 30åˆ†é’Ÿ
            
            console.log('æ°´è´¨ç›‘æµ‹åˆå§‹åŒ–å®Œæˆ');
            
        } catch (error) {
            console.error('åˆå§‹åŒ–æ°´è´¨ç›‘æµ‹å¤±è´¥:', error);
        }
    }

    // // æ›´æ–°æ°´è´¨è­¦æŠ¥
    // async function updateWaterQualityAlerts(selectedRanchIndex) {

    // }

    // // åˆå§‹åŒ–æ°´è´¨æ•°æ®
    // async function initWaterQualityMonitoring() {
    //     // try {
    //     //     // è°ƒç”¨APIè·å–æ°´è´¨æ•°æ®
    //     //     const response = await fetch('/api/water_quality');
    //     //     if (!response.ok) {
    //     //         console.error('åŠ è½½æ°´è´¨æ•°æ®å¤±è´¥:', response.statusText);
    //     //         return;
    //     //     }
            
    //     //     globalWaterQualityData = await response.json();
    //     // } catch (error) {
    //     //     console.error('åŠ è½½æ°´è´¨æ•°æ®æ—¶å‡ºé”™:', error);
    //     // }
    // }

/*
    * å¤©æ°”è­¦æŠ¥å¤„ç†
*/

    // å…¨å±€å¤©æ°”æ•°æ®å­˜å‚¨
    let globalWeatherData = {};

    // å¤©æ°”å¼‚å¸¸æ£€æµ‹è§„åˆ™
    const weatherAlertRules = {
        // æç«¯å¤©æ°”æ¡ä»¶
        extremeWeather: {
            codes: [95, 96, 99], // é›·æš´åŠé›·æš´ä¼´æœ‰å†°é›¹
            level: 'danger',
            type: 'æç«¯å¤©æ°”',
            getMessage: (data) => `å½“å‰å‡ºç°${data.weather}ï¼Œè¯·ç«‹å³é‡‡å–é˜²æŠ¤æªæ–½ï¼`
        },
        // å¼ºé™æ°´
        heavyRain: {
            codes: [65, 67, 75, 77, 82, 86], // å¤§é›¨ã€å¼ºå†»é›¨ã€å¤§é›ªã€é›ªç²’ã€å¤§é˜µé›¨ã€å¤§é˜µé›ª
            level: 'danger',
            type: 'å¼ºé™æ°´',
            getMessage: (data) => `${data.weather}è­¦å‘Šï¼Œå¯èƒ½å½±å“æµ·ä¸Šä½œä¸šå®‰å…¨ã€‚`
        },
        // ä¸­ç­‰é™æ°´
        moderateRain: {
            codes: [53, 55, 63, 73, 81], // ä¸­åº¦æ¯›æ¯›é›¨ã€æµ“æ¯›æ¯›é›¨ã€ä¸­é›¨ã€ä¸­é›ªã€ä¸­é˜µé›¨
            level: 'warning',
            type: 'ä¸­ç­‰é™æ°´',
            getMessage: (data) => `${data.weather}æŒç»­ä¸­ï¼Œè¯·åšå¥½é˜²æŠ¤å‡†å¤‡ã€‚`
        },
        // å¤§é£
        strongWind: {
            threshold: 40, // é£é€Ÿè¶…è¿‡40km/h
            level: 'warning',
            type: 'å¤§é£',
            getMessage: (data) => `é£é€Ÿè¾¾åˆ°${data.wind.toFixed(1)}km/hï¼Œè¯·æ³¨æ„æµ·ä¸Šä½œä¸šå®‰å…¨ã€‚`
        },
        // ä½èƒ½è§åº¦
        lowVisibility: {
            codes: [45, 48, 56, 57], // æœ‰é›¾ã€æ²‰ç§¯é›¾å‡‡ã€å†»æ¯›æ¯›é›¨ã€å¼ºå†»æ¯›æ¯›é›¨
            level: 'warning',
            type: 'èƒ½è§åº¦',
            getMessage: (data) => `å‡ºç°${data.weather}ï¼Œèƒ½è§åº¦é™ä½ï¼Œè¯·æ³¨æ„èˆªè¡Œå®‰å…¨ã€‚`
        },
        // é™é›ªæ¡ä»¶
        snowCondition: {
            codes: [71, 73, 75, 77, 85, 86], // å„ç±»é™é›ª
            level: 'warning',
            type: 'é™é›ª',
            getMessage: (data) => `${data.weather}å¯èƒ½å¯¼è‡´è·¯é¢ç»“å†°ï¼Œè¯·æ³¨æ„å®‰å…¨ã€‚`
        },
        // æ¸©åº¦å¼‚å¸¸
        temperatureAnomaly: {
            highTemp: 35, // è‹¥è¦éªŒè¯è­¦æŠ¥åŠŸèƒ½ï¼Œå¯ä»¥é™ä½highTempï¼ˆæ¯”å¦‚15ï¼‰
            lowTemp: -5,
            level: 'info',
            type: 'æ¸©åº¦å¼‚å¸¸',
            getMessage: (data) => {
                if (data.temp > 35) { // éªŒè¯è­¦æŠ¥åŠŸèƒ½ï¼Œè¿™é‡Œä¹Ÿè¦è¿›è¡Œç›¸åº”ä¿®æ”¹
                    return `é«˜æ¸©é¢„è­¦ï¼šå½“å‰æ¸©åº¦${data.temp}Â°Cï¼Œè¯·æ³¨æ„é˜²æš‘é™æ¸©ã€‚`;
                } else if (data.temp < -5) {
                    return `ä½æ¸©é¢„è­¦ï¼šå½“å‰æ¸©åº¦${data.temp}Â°Cï¼Œè¯·æ³¨æ„é˜²å¯’ä¿æš–ã€‚`;
                }
                return null;
            }
        }
    };

    // æ£€æµ‹å¤©æ°”å¼‚å¸¸
    function detectWeatherAnomalies(weatherData) {
        const alerts = [];
        
        // æ£€æŸ¥æç«¯å¤©æ°”
        if (weatherAlertRules.extremeWeather.codes.includes(weatherData.weatherCode)) {
            alerts.push({
                level: weatherAlertRules.extremeWeather.level,
                type: weatherAlertRules.extremeWeather.type,
                message: weatherAlertRules.extremeWeather.getMessage({
                    weather: weatherData.weather,
                    temp: weatherData.temp,
                    wind: weatherData.wind
                }),
                timestamp: new Date().toISOString()
            });
        }
        
        // æ£€æŸ¥å¼ºé™æ°´
        if (weatherAlertRules.heavyRain.codes.includes(weatherData.weatherCode)) {
            alerts.push({
                level: weatherAlertRules.heavyRain.level,
                type: weatherAlertRules.heavyRain.type,
                message: weatherAlertRules.heavyRain.getMessage({
                    weather: weatherData.weather,
                    temp: weatherData.temp,
                    wind: weatherData.wind
                }),
                timestamp: new Date().toISOString()
            });
        }
        
        // æ£€æŸ¥ä¸­ç­‰é™æ°´
        if (weatherAlertRules.moderateRain.codes.includes(weatherData.weatherCode)) {
            alerts.push({
                level: weatherAlertRules.moderateRain.level,
                type: weatherAlertRules.moderateRain.type,
                message: weatherAlertRules.moderateRain.getMessage({
                    weather: weatherData.weather,
                    temp: weatherData.temp,
                    wind: weatherData.wind
                }),
                timestamp: new Date().toISOString()
            });
        }
        
        // æ£€æŸ¥é™é›ªæ¡ä»¶
        if (weatherAlertRules.snowCondition.codes.includes(weatherData.weatherCode)) {
            alerts.push({
                level: weatherAlertRules.snowCondition.level,
                type: weatherAlertRules.snowCondition.type,
                message: weatherAlertRules.snowCondition.getMessage({
                    weather: weatherData.weather,
                    temp: weatherData.temp,
                    wind: weatherData.wind
                }),
                timestamp: new Date().toISOString()
            });
        }
        
        // æ£€æŸ¥å¤§é£
        if (weatherData.wind > weatherAlertRules.strongWind.threshold) {
            alerts.push({
                level: weatherAlertRules.strongWind.level,
                type: weatherAlertRules.strongWind.type,
                message: weatherAlertRules.strongWind.getMessage({
                    weather: weatherData.weather,
                    temp: weatherData.temp,
                    wind: weatherData.wind
                }),
                timestamp: new Date().toISOString()
            });
        }
        
        // æ£€æŸ¥èƒ½è§åº¦
        if (weatherAlertRules.lowVisibility.codes.includes(weatherData.weatherCode)) {
            alerts.push({
                level: weatherAlertRules.lowVisibility.level,
                type: weatherAlertRules.lowVisibility.type,
                message: weatherAlertRules.lowVisibility.getMessage({
                    weather: weatherData.weather,
                    temp: weatherData.temp,
                    wind: weatherData.wind
                }),
                timestamp: new Date().toISOString()
            });
        }
        
        // æ£€æŸ¥æ¸©åº¦å¼‚å¸¸
        if (weatherData.temp > weatherAlertRules.temperatureAnomaly.highTemp || 
            weatherData.temp < weatherAlertRules.temperatureAnomaly.lowTemp) {
            const tempMessage = weatherAlertRules.temperatureAnomaly.getMessage({
                weather: weatherData.weather,
                temp: weatherData.temp,
                wind: weatherData.wind
            });
            
            if (tempMessage) {
                alerts.push({
                    level: weatherAlertRules.temperatureAnomaly.level,
                    type: weatherAlertRules.temperatureAnomaly.type,
                    message: tempMessage,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        return alerts;
    }

    // æ›´æ–°å¤©æ°”è­¦æŠ¥
    async function updateWeatherAlerts(selectedRanchIndex) {
        const weatherData = Object.values(globalWeatherData);
        
        if (selectedRanchIndex !== null && selectedRanchIndex !== '') {
            const selectedRanch = marineRanches[selectedRanchIndex];
            const ranchWeather = weatherData.find(w => w.name === selectedRanch.name);
            
            if (ranchWeather) {
                // æ£€æµ‹å¤©æ°”å¼‚å¸¸
                const weatherAlerts = detectWeatherAnomalies(ranchWeather);
                
                // è·å–ä¸Šä¸€æ¬¡çš„è­¦æŠ¥
                let previousAlerts = [];
                try {
                    previousAlerts = await csvOperations.loadAlertsFromCSV(selectedRanch.name);
                } catch (error) {
                    console.error("è·å–å†å²è­¦æŠ¥å¤±è´¥:", error);
                }
                
                // å°†å¤©æ°”è­¦æŠ¥æ›´æ–°åˆ°CSVæ–‡ä»¶
                const allAlerts = await csvOperations.updateAlertsInCSV(selectedRanch.name, weatherAlerts);
                
                // è¯†åˆ«æ–°çš„è­¦æŠ¥ï¼ˆå½“å‰æ£€æµ‹åˆ°ä½†ä¸åœ¨å†å²è®°å½•ä¸­çš„è­¦æŠ¥ï¼‰
                const newAlerts = weatherAlerts.filter(alert => {
                    // æ£€æŸ¥å†å²è®°å½•ä¸­æ˜¯å¦å·²æœ‰åŒç±»å‹çš„è­¦æŠ¥
                    return !previousAlerts.some(prevAlert => 
                        prevAlert.type === alert.type && 
                        prevAlert.level === alert.level && 
                        prevAlert.message === alert.message
                    );
                });
                
                // // ä¸ºæ–°çš„è­¦æŠ¥æ˜¾ç¤ºå¼¹çª—
                // newAlerts.forEach(alert => {
                //     alertPopupSystem.showAlertPopup(alert);
                // });
                alertPopupSystem.showAlerts(newAlerts);
                
                // æ›´æ–°è­¦æŠ¥æ•°é‡
                document.getElementById('alertCount').textContent = `${allAlerts.length}ä¸ª`;
                
                // æ›´æ–°è­¦æŠ¥æ˜¾ç¤º
                const alertsContainer = document.getElementById('alertsContainer');
                alertsContainer.innerHTML = '';
                if (allAlerts.length === 0) {
                    alertsContainer.innerHTML = '<div class="alert alert-success">å½“å‰æ— å‘Šè­¦ä¿¡æ¯ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚</div>';
                } else {
                    allAlerts.forEach((alert, index) => {
                        const alertDiv = `
                            <div class="alert alert-${alert.level}">
                                <strong>${alert.type}ï¼š</strong> ${alert.message}
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAlertHandler('${selectedRanch.name}', ${index})">
                                        <i class="fas fa-times"></i> åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                        alertsContainer.innerHTML += alertDiv;
                    });
                }
                
                // æ›´æ–°å¤©æ°”ä¿¡æ¯æ˜¾ç¤º
                const waterQualityElement = document.getElementById('waterQuality');
                waterQualityElement.innerHTML = `${waterQualityElement.textContent} | ${ranchWeather.weatherIcon} ${ranchWeather.weather} ${ranchWeather.temp}Â°C`;
            }
        }
    }

    // åˆå§‹åŒ–å¤©æ°”ç›‘æµ‹
    async function initWeatherMonitoring() {
        try {
            // è·å–åˆå§‹å¤©æ°”æ•°æ®
            const weatherData = await fetchMarineRanchWeatherData(marineRanches);
            
            // å­˜å‚¨åˆ°å…¨å±€å˜é‡
            weatherData.forEach(data => {
                globalWeatherData[data.name] = data;
            });

            console.log('å…¨å±€å¤©æ°”æ•°æ®:', globalWeatherData);
            
            // å¦‚æœæœ‰é€‰ä¸­çš„ç‰§åœºï¼Œç«‹å³æ›´æ–°è­¦æŠ¥
            const selectedIndex = localStorage.getItem('selectedMarineFarm');
            if (selectedIndex !== null && selectedIndex !== '') {
                await updateWeatherAlerts(selectedIndex);
            }
            
            // å®šæœŸæ›´æ–°å¤©æ°”æ•°æ®ï¼ˆæ¯10åˆ†é’Ÿï¼‰
            setInterval(async () => {
                const newWeatherData = await fetchMarineRanchWeatherData(marineRanches);
                newWeatherData.forEach(data => {
                    globalWeatherData[data.name] = data;
                });
                
                // æ›´æ–°å½“å‰é€‰ä¸­ç‰§åœºçš„è­¦æŠ¥
                const currentIndex = document.getElementById('marineFarmSelect').value;
                if (currentIndex !== '') {
                    await updateWeatherAlerts(currentIndex);
                }
            }, 600000); // 10åˆ†é’Ÿ
            
        } catch (error) {
            console.error('åˆå§‹åŒ–å¤©æ°”ç›‘æµ‹å¤±è´¥:', error);
        }
    }

/*
    * é¡µé¢å†…å®¹çš„æ›´æ–°ä¸åˆå§‹åŒ–
*/

    // æ›´æ–°é¡µé¢å†…å®¹çš„å‡½æ•°
    async function updateRanchContent(ranchIndex) {
        if (ranchIndex === "" || ranchIndex === null) {
            // æ¸…ç©ºå†…å®¹
            document.getElementById('ranchNameTitle').textContent = 'è¯·é€‰æ‹©æµ·æ´‹ç‰§åœº';
            document.getElementById('seaArea').textContent = '-';
            document.getElementById('speciesCount').textContent = '-';
            document.getElementById('waterQuality').textContent = '-';
            document.getElementById('alertCount').textContent = '-';
            document.getElementById('location').textContent = '-';
            document.getElementById('waterDepth').textContent = '-';
            document.getElementById('currentStatus').textContent = '-';
            document.getElementById('establishTime').textContent = '-';
            document.getElementById('introduction').textContent = '-';
            document.getElementById('speciesList').innerHTML = '';
            document.getElementById('alertsContainer').innerHTML = '<p class="text-muted">è¯·é€‰æ‹©æµ·æ´‹ç‰§åœºæŸ¥çœ‹å‘Šè­¦ä¿¡æ¯</p>';
            return;
        }

        const data = marineRanchData[ranchIndex];
        
        // æ›´æ–°åŸºæœ¬ä¿¡æ¯
        document.getElementById('ranchNameTitle').textContent = data.name;
        document.getElementById('seaArea').textContent = data.seaArea;
        document.getElementById('speciesCount').textContent = data.speciesCount;
        document.getElementById('waterQuality').textContent = data.waterQuality;
        
        // æ›´æ–°æ°´åŸŸä»‹ç»
        document.getElementById('location').textContent = data.location;
        document.getElementById('waterDepth').textContent = data.waterDepth;
        document.getElementById('currentStatus').textContent = data.currentStatus;
        document.getElementById('establishTime').textContent = data.establishTime;
        document.getElementById('introduction').textContent = data.introduction;
        
        // æ›´æ–°å…»æ®–ç§ç±»
        const speciesList = document.getElementById('speciesList');
        speciesList.innerHTML = '';
        data.species.forEach(species => {
            const speciesCard = `
                <div class="col-md-3 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${species.name}</h6>
                            <p class="card-text mb-1"><small>æ•°é‡ï¼š${species.quantity}</small></p>
                            <p class="card-text mb-0"><small>çŠ¶æ€ï¼š<span class="text-success">${species.status}</span></small></p>
                        </div>
                    </div>
                </div>
            `;
            speciesList.innerHTML += speciesCard;
        });
        
        // ä»CSVæ–‡ä»¶åŠ è½½è­¦æŠ¥æ•°æ®
        const selectedRanch = marineRanches[ranchIndex];
        const alerts = await csvOperations.loadAlertsFromCSV(selectedRanch.name);
        
        // æ›´æ–°è­¦æŠ¥æ•°é‡
        document.getElementById('alertCount').textContent = `${alerts.length}ä¸ª`;
        
        // æ›´æ–°å‘Šè­¦ä¿¡æ¯
        const alertsContainer = document.getElementById('alertsContainer');
        alertsContainer.innerHTML = '';
        if (alerts.length === 0) {
            alertsContainer.innerHTML = '<div class="alert alert-success">å½“å‰æ— å‘Šè­¦ä¿¡æ¯ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚</div>';
        } else {
            alerts.forEach((alert, index) => {
                const alertDiv = `
                    <div class="alert alert-${alert.level}">
                        <strong>${alert.type}ï¼š</strong> ${alert.message}
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAlertHandler('${selectedRanch.name}', ${index})">
                                <i class="fas fa-times"></i> åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
                alertsContainer.innerHTML += alertDiv;
            });
        }
    }

    // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç›‘æµ‹
    document.addEventListener('DOMContentLoaded', async function() {
        // åˆå§‹åŒ–è­¦æŠ¥æ–‡ä»¶
        const ranchNames = marineRanches.map(ranch => ranch.name);
        await csvOperations.initAlertsFiles(ranchNames);
        
        const savedIndex = localStorage.getItem('selectedMarineFarm');
        if (savedIndex !== null && savedIndex !== '') {
            await updateRanchContent(savedIndex);
        }
        
        // åˆå§‹åŒ–å¤©æ°”ç›‘æµ‹
        await initWeatherMonitoring();
        await initWaterQualityMonitoring();
        // å¯è¡¥å……ï¼šåˆå§‹åŒ–å…¶ä»–ç›‘æµ‹ï¼ˆæ°´è´¨æ•°æ®ã€é±¼ç¾¤æ•°æ®ã€è®¾å¤‡ï¼‰
    });


    // ç›‘å¬æµ·æ´‹ç‰§åœºé€‰æ‹©å˜åŒ–
    window.addEventListener('marineFarmChanged', function(e) {
        const selectedIndex = document.getElementById('marineFarmSelect').value;
        alertPopupSystem.clearShownAlerts();
        updateRanchContent(selectedIndex);
    });
</script>

<script>
    // åœ¨windowå…¨å±€å¯¹è±¡ä¸Šæ³¨å†Œåˆ é™¤è­¦æŠ¥çš„å¤„ç†å‡½æ•°
    window.deleteAlertHandler = async function(ranchName, alertIndex) {
        // ç¡®è®¤åˆ é™¤
        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è­¦æŠ¥å—ï¼Ÿ')) {
            // è°ƒç”¨APIåˆ é™¤è­¦æŠ¥
            const updatedAlerts = await csvOperations.deleteAlert(ranchName, alertIndex);
            
            if (updatedAlerts) {
                // æ›´æ–°å½“å‰æ˜¾ç¤º
                const currentIndex = document.getElementById('marineFarmSelect').value;
                if (currentIndex !== '') {
                    await updateRanchContent(currentIndex);
                }
            }
        }
    };
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Info</title>
</head>
</html>
{% endblock %}