{% extends "base.html" %}

{% block content %}
    <div class="container-fluid">
        <!-- 新增数据管理下拉菜单 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-4">数据中心</h1>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" 
                        id="dataManagementDropdown" data-bs-toggle="dropdown"
                        aria-expanded="false">
                    <i class="fas fa-database me-2"></i>数据管理
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" id="uploadDataBtn" data-bs-toggle="modal" data-bs-target="#uploadFishModal">
                        <i class="fas fa-cloud-upload-alt me-2"></i>上传鱼类数据
                    </a></li>
                    <li><a class="dropdown-item" href="#" id="exportDataBtn" data-bs-toggle="modal" data-bs-target="#exportFishModal">
                        <i class="fas fa-download me-2"></i>导出鱼类数据
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="downloadChartBtn">
                        <i class="fas fa-image me-2"></i>下载雷达图
                    </a></li>
                </ul>
            </div>
        </div>
        
        
        <!-- 数据概览卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-database me-2"></i>数据总量</h5>
                        <p class="card-text">1.2 TB</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-video me-2"></i>视频数据</h5>
                        <p class="card-text">850 GB</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-tachometer-alt me-2"></i>传感器数据</h5>
                        <p class="card-text">350 GB</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-cloud-upload-alt me-2"></i>存储空间</h5>
                        <p class="card-text">剩余 2.8 TB</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 鱼类数据展示部分 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-fish me-2"></i>鱼类数据展示
                    </div>
                    <div class="card-body">
                        <!-- 牧场和鱼类选择器 -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="marineFarmSelect" class="form-label">选择海洋牧场：</label>
                                <select class="form-select" id="marineFarmSelect">
                                    <option value="0">山东青岛</option>
                                    <option value="1">浙江舟山</option>
                                    <option value="2">福建厦门</option>
                                    <option value="3">广东湛江</option>
                                    <option value="4">辽宁大连</option>
                                    <option value="5">河北秦皇岛</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="fishSpecies" class="form-label">选择鱼类种类：</label>
                                <select class="form-select" id="fishSpecies">
                                    <option value="Bream">Bream (鲤科)</option>
                                    <option value="Roach">Roach (拟鲤)</option>
                                    <option value="Whitefish">Whitefish (白鱼)</option>
                                    <option value="Parkki">Parkki (鲈鱼)</option>
                                    <option value="Perch">Perch (鲈鱼)</option>
                                    <option value="Pike">Pike (梭鱼)</option>
                                    <option value="Smelt">Smelt (胡瓜鱼)</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="loadFishData" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>加载数据
                                </button>
                            </div>
                        </div>
                        
                        <!-- 鱼类图片和雷达图展示 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-image me-2"></i>鱼类图片
                                    </div>
                                    <div class="card-body text-center">
                                        <img id="fishImage" src="{{ url_for('static', filename='images/Bream.png') }}" 
                                             alt="鱼类图片" class="img-fluid rounded" style="max-height: 300px;">
                                        <h4 id="fishName" class="mt-3">Bream</h4>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 雷达图展示 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-pie me-2"></i>数据雷达图
                                        <button class="btn btn-sm btn-outline-secondary" id="downloadRadarChartBtn" title="下载图表"><i class="fas fa-download"></i></button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="dataAttribute" class="form-label">数据属性：</label>
                                                <select class="form-select" id="dataAttribute">
                                                    <option value="Weight(g)">体重</option>
                                                    <option value="Length1(cm)">长度1</option>
                                                    <option value="Length2(cm)">长度2</option>
                                                    <option value="Length3(cm)">长度3</option>
                                                    <option value="Height(cm)">高度</option>
                                                    <option value="Width(cm)">宽度</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="chart-container">
                                            <canvas id="fishRadarChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 鱼类统计数据 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-bar me-2"></i>统计数据
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <h6>平均体重</h6>
                                                    <p id="avgWeight" class="h4 text-primary">0 g</p>
                                                </div>
                                                <div class="mb-3">
                                                    <h6>平均长度</h6>
                                                    <p id="avgLength" class="h4 text-info">0 cm</p>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <h6>平均高度</h6>
                                                    <p id="avgHeight" class="h4 text-success">0 cm</p>
                                                </div>
                                                <div class="mb-3">
                                                    <h6>平均宽度</h6>
                                                    <p id="avgWidth" class="h4 text-warning">0 cm</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <h6>样本数量</h6>
                                            <p id="sampleCount" class="h5">0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 极值数据 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-line me-2"></i>极值数据
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <h6>最大体重</h6>
                                                    <p id="maxWeight" class="h4 text-primary">0 g</p>
                                                </div>
                                                <div class="mb-3">
                                                    <h6>最小体重</h6>
                                                    <p id="minWeight" class="h4 text-info">0 g</p>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <h6>最大长度</h6>
                                                    <p id="maxLength" class="h4 text-success">0 cm</p>
                                                </div>
                                                <div class="mb-3">
                                                    <h6>最小长度</h6>
                                                    <p id="minLength" class="h4 text-warning">0 cm</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 鱼类数据表格 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-table me-2"></i>详细数据
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>编号</th>
                                                        <th>体重(g)</th>
                                                        <th>长度1(cm)</th>
                                                        <th>长度2(cm)</th>
                                                        <th>长度3(cm)</th>
                                                        <th>高度(cm)</th>
                                                        <th>宽度(cm)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="fishDataTable">
                                                    <!-- 数据将通过JavaScript动态填充 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 鱼类数据预测 -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-chart-line me-2"></i>数据预测
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="predictionMonths" class="form-label">预测时长：</label>
                                                <select class="form-select" id="predictionMonths">
                                                    <option value="3">3个月后</option>
                                                    <option value="6">6个月后</option>
                                                    <option value="12">12个月后</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 d-flex align-items-end">
                                                <button id="predictBtn" class="btn btn-primary">
                                                    <i class="fas fa-calculator me-2"></i>开始预测
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- 预测结果展示 -->
                                        <div id="predictionResults" class="mt-3" style="display: none;">
                                            <h5>预测结果（预测日期：<span id="predictionDate"></span>）</h5>
                                            <div class="table-responsive">
                                                <table class="table table-bordered">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>指标</th>
                                                            <th>当前平均值</th>
                                                            <th>预测值</th>
                                                            <th>增长率</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="predictionTableBody">
                                                        <!-- 预测结果将通过JavaScript动态填充 -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        <!-- 预测图表 -->
                                        <div class="row mt-4">
                                            <div class="col-12">
                                                <div class="chart-container">
                                                    <canvas id="predictionChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 数据存储状态 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-hdd me-2"></i>存储状态
                    </div>
                    <div class="card-body">
                        <h5>主存储服务器</h5>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">65%</div>
                        </div>
                        <p>已使用: 650 GB / 总容量: 1 TB</p>
                        
                        <h5>备份存储服务器</h5>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 45%;" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100">45%</div>
                        </div>
                        <p>已使用: 450 GB / 总容量: 1 TB</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-file-alt me-2"></i>数据备份状态
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <strong>成功：</strong> 上次备份完成于 2025-05-04 08:30:00
                        </div>
                        <div class="mb-3">
                            <label for="backupSchedule" class="form-label">备份计划</label>
                            <select class="form-select" id="backupSchedule">
                                <option selected>每天 02:00 自动备份</option>
                                <option>每天 04:00 自动备份</option>
                                <option>每天 06:00 自动备份</option>
                            </select>
                        </div>
                        <button class="btn btn-primary">立即执行备份</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 鱼类数据导出模态框 -->
    <div class="modal fade" id="exportFishModal" tabindex="-1" aria-labelledby="exportFishModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exportFishModalLabel">导出鱼类数据</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="fishExportForm">
              <div class="mb-3">
                <label class="form-label">选择海洋牧场</label>
                <select class="form-select" id="fishExportRanchSelect">
                  <option value="">请选择</option>
                  <option value="山东青岛">山东青岛</option>
                  <option value="浙江舟山">浙江舟山</option>
                  <option value="福建厦门">福建厦门</option>
                  <option value="广东湛江">广东湛江</option>
                  <option value="辽宁大连">辽宁大连</option>
                  <option value="河北秦皇岛">河北秦皇岛</option>
                </select>
              </div>
              <div class="mb-3">
                <div id="fishExportStatus" class="small text-muted mt-1"></div>
              </div>
              <button type="button" class="btn btn-success w-100" id="startFishExportBtn">导出</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== 上传鱼类数据模态框 ====== -->
    <div class="modal fade" id="uploadFishModal" tabindex="-1" aria-labelledby="uploadFishModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadFishModalLabel">上传鱼类数据</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="fishUploadForm">
              <div class="mb-3">
                <label class="form-label">选择海洋牧场</label>
                <select class="form-select" id="fishUploadRanchSelect" required>
                  <option value="">请选择</option>
                  <option value="山东青岛">山东青岛</option>
                  <option value="浙江舟山">浙江舟山</option>
                  <option value="福建厦门">福建厦门</option>
                  <option value="广东湛江">广东湛江</option>
                  <option value="辽宁大连">辽宁大连</option>
                  <option value="河北秦皇岛">河北秦皇岛</option>
                </select>
              </div>
              <div class="mb-3 d-flex justify-content-between align-items-center">
                <button type="button" class="btn btn-outline-secondary" id="downloadFishTemplateBtn" disabled>
                  <i class="fas fa-file-csv me-2"></i>下载CSV`模板
                </button>
                <span class="small text-muted">仅支持.csv文件</span>
              </div>
              <div class="mb-3">
                <div id="fishUploadDropArea" class="border border-2 rounded p-4 text-center bg-light" style="cursor:pointer;">
                  <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                  <div>拖拽或点击选择CSV文件上传</div>
                  <input type="file" id="fishUploadFileInput" accept=".csv" style="display:none;">
                </div>
              </div>
              <div class="mb-3">
                <div id="fishUploadStatus" class="small text-danger"></div>
              </div>
              <button type="submit" class="btn btn-success w-100" id="startFishUploadBtn" disabled>上传</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
        // 鱼类数据 - 存储所有牧场的数据
        let allFishData = {};
        let currentFishData = [];
        let fishRadarChart = null;
        let currentRanchIndex = 0;
        
        // 牧场与数据文件映射
        const ranchFileMap = {
            0: './Fish/Fish_山东青岛.csv',   // 山东青岛
            1: './Fish/Fish_浙江舟山.csv',   // 浙江舟山
            2: './Fish/Fish_福建厦门.csv',   // 福建厦门
            3: './Fish/Fish_广东湛江.csv',   // 广东湛江
            4: './Fish/Fish_辽宁大连.csv',   // 辽宁大连
            5: './Fish/Fish_河北秦皇岛.csv'  // 河北秦皇岛
        };

        // 牧场名称
        const ranchNames = ['山东青岛', '浙江舟山', '福建厦门', '广东湛江', '辽宁大连', '河北秦皇岛'];
        
        // 加载所有牧场数据
        async function loadAllFishData() {
            try {
                // 清空之前的数据
                allFishData = {};
                
                // 遍历所有牧场文件
                for (let ranchIndex in ranchFileMap) {
                    const fileName = ranchFileMap[ranchIndex];
                    const response = await fetch("{{ url_for('static', filename='') }}" + fileName);
                    const csvData = await response.text();
                    
                    // 解析CSV数据
                    const lines = csvData.split('\n');
                    const headers = lines[0].split(',');
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        const values = lines[i].split(',');
                        const fish = {};
                        
                        for (let j = 0; j < headers.length; j++) {
                            fish[headers[j].trim()] = values[j].trim();
                        }
                        
                        const species = fish.Species;
                        if (!allFishData[species]) {
                            allFishData[species] = {};
                        }
                        
                        // 按牧场存储数据
                        if (!allFishData[species][ranchIndex]) {
                            allFishData[species][ranchIndex] = [];
                        }
                        allFishData[species][ranchIndex].push(fish);
                    }
                }
                
                console.log('所有牧场鱼类数据加载完成', allFishData);
                // 默认加载Bream数据
                updateFishDisplay();
                // 初始化雷达图
                updateRadarChart(document.getElementById('fishSpecies').value);
            } catch (error) {
                console.error('加载鱼类数据失败:', error);
                alert('加载鱼类数据失败，请刷新页面重试。');
            }
        }
        
        // 更新鱼类显示
        function updateFishDisplay() {
            const selectedSpecies = document.getElementById('fishSpecies').value;
            currentRanchIndex = document.getElementById('marineFarmSelect').value;
            
            // 获取当前牧场当前种类的鱼
            currentFishData = allFishData[selectedSpecies]?.[currentRanchIndex] || [];
            
            if (currentFishData.length === 0) {
                console.warn(`没有找到 ${selectedSpecies} 的数据`);
                return;
            }
            
            // 更新图片和名称
            document.getElementById('fishImage').src = `{{ url_for('static', filename='images/') }}${selectedSpecies}.png`;
            document.getElementById('fishName').textContent = selectedSpecies;
            
            // 计算统计数据
            const weights = currentFishData.map(fish => parseFloat(fish['Weight(g)']));
            const length1s = currentFishData.map(fish => parseFloat(fish['Length1(cm)']));
            const length2s = currentFishData.map(fish => parseFloat(fish['Length2(cm)']));
            const length3s = currentFishData.map(fish => parseFloat(fish['Length3(cm)']));
            const heights = currentFishData.map(fish => parseFloat(fish['Height(cm)']));
            const widths = currentFishData.map(fish => parseFloat(fish['Width(cm)']));
            
            const totalWeight = weights.reduce((sum, w) => sum + w, 0);
            const totalLength1 = length1s.reduce((sum, l) => sum + l, 0);
            const totalLength2 = length2s.reduce((sum, l) => sum + l, 0);
            const totalLength3 = length3s.reduce((sum, l) => sum + l, 0);
            const totalHeight = heights.reduce((sum, h) => sum + h, 0);
            const totalWidth = widths.reduce((sum, w) => sum + w, 0);
            
            const avgWeight = (totalWeight / currentFishData.length).toFixed(2);
            const avgLength1 = (totalLength1 / currentFishData.length).toFixed(2);
            const avgLength2 = (totalLength2 / currentFishData.length).toFixed(2);
            const avgLength3 = (totalLength3 / currentFishData.length).toFixed(2);
            const avgHeight = (totalHeight / currentFishData.length).toFixed(2);
            const avgWidth = (totalWidth / currentFishData.length).toFixed(2);
            
            const maxWeight = Math.max(...weights).toFixed(2);
            const minWeight = Math.min(...weights).toFixed(2);
            const maxLength = Math.max(...length3s).toFixed(2);
            const minLength = Math.min(...length1s).toFixed(2);
            
            // 更新统计信息
            document.getElementById('avgWeight').textContent = `${avgWeight} g`;
            document.getElementById('avgLength').textContent = `${avgLength1} / ${avgLength2} / ${avgLength3} cm`;
            document.getElementById('avgHeight').textContent = `${avgHeight} cm`;
            document.getElementById('avgWidth').textContent = `${avgWidth} cm`;
            document.getElementById('sampleCount').textContent = currentFishData.length;
            
            // 更新极值数据
            document.getElementById('maxWeight').textContent = `${maxWeight} g`;
            document.getElementById('minWeight').textContent = `${minWeight} g`;
            document.getElementById('maxLength').textContent = `${maxLength} cm`;
            document.getElementById('minLength').textContent = `${minLength} cm`;
            
            // 更新表格数据
            const tableBody = document.getElementById('fishDataTable');
            tableBody.innerHTML = '';
            
            currentFishData.forEach((fish, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${fish['Weight(g)']}</td>
                    <td>${fish['Length1(cm)']}</td>
                    <td>${fish['Length2(cm)']}</td>
                    <td>${fish['Length3(cm)']}</td>
                    <td>${fish['Height(cm)']}</td>
                    <td>${fish['Width(cm)']}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 更新雷达图 - 显示所有牧场数据
        function updateRadarChart(species) {
            const dataAttribute = document.getElementById('dataAttribute').value;
            
            // 准备雷达图数据
            const avgData = [];
            const maxData = [];
            const minData = [];
            
            // 遍历所有牧场
            for (let ranchIndex in ranchFileMap) {
                const ranchFishData = allFishData[species]?.[ranchIndex] || [];
                
                if (ranchFishData.length > 0) {
                    const values = ranchFishData.map(fish => parseFloat(fish[dataAttribute]));
                    const avg = values.reduce((sum, v) => sum + v, 0) / values.length;
                    const max = Math.max(...values);
                    const min = Math.min(...values);
                    
                    avgData.push(avg);
                    maxData.push(max);
                    minData.push(min);
                } else {
                    // 如果没有数据，填充0
                    avgData.push(0);
                    maxData.push(0);
                    minData.push(0);
                }
            }
            
            // 创建或更新雷达图
            const ctx = document.getElementById('fishRadarChart').getContext('2d');
            
            if (fishRadarChart) {
                fishRadarChart.destroy();
            }
            
            fishRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ranchNames,
                    datasets: [
                        {
                            label: '平均值',
                            data: avgData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                            pointRadius: 4
                        },
                        {
                            label: '最大值',
                            data: maxData,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                            pointRadius: 4
                        },
                        {
                            label: '最小值',
                            data: minData,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '各地区鱼类数据对比'
                        }
                    }
                }
            });
        }
        
        // 添加下载图表功能(右上角选择器)
        document.getElementById('downloadChartBtn').addEventListener('click', function() {
            if (!fishRadarChart) {
                alert('请先加载图表数据');
                return;
            }

            // 获取当前选择信息
            const ranchSelect = document.getElementById('marineFarmSelect');
            const ranchName = ranchSelect.options[ranchSelect.selectedIndex].text.replace(/\s+/g, '');
            
            const fishSelect = document.getElementById('fishSpecies');
            const fishName = fishSelect.options[fishSelect.selectedIndex].text
                .replace(/\s+/g, '') // 移除所有空格
                .replace(/\(/g, '（').replace(/\)/g, '）'); // 替换括号为全角
            
            const attributeSelect = document.getElementById('dataAttribute');
            const attributeName = attributeSelect.options[attributeSelect.selectedIndex].text;

            // 创建文件名（包含过滤非法字符）
            const cleanFileName = `${ranchName}_${fishName}_${attributeName}_水质数据雷达图_${new Date().toISOString().slice(0,10)}`
                .replace(/[\\/:*?"<>|]/g, ''); // 移除非法文件字符

            // 创建高清Canvas
            const tempCanvas = document.createElement('canvas');
            const originalCanvas = document.getElementById('fishRadarChart');
            const scale = 2;
            
            tempCanvas.width = originalCanvas.width * scale;
            tempCanvas.height = originalCanvas.height * scale;
            tempCanvas.style.width = originalCanvas.width + 'px';
            tempCanvas.style.height = originalCanvas.height + 'px';

            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.scale(scale, scale);
            tempCtx.drawImage(originalCanvas, 0, 0);

            // 触发下载
            const link = document.createElement('a');
            link.download = `${cleanFileName}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        });
        
        // 添加下载图表功能(小图标)
        document.getElementById('downloadRadarChartBtn').addEventListener('click', function() {
            if (!fishRadarChart) {
                alert('请先加载图表数据');
                return;
            }

            // 获取当前选择信息
            const ranchSelect = document.getElementById('marineFarmSelect');
            const ranchName = ranchSelect.options[ranchSelect.selectedIndex].text.replace(/\s+/g, '');
            
            const fishSelect = document.getElementById('fishSpecies');
            const fishName = fishSelect.options[fishSelect.selectedIndex].text
                .replace(/\s+/g, '') // 移除所有空格
                .replace(/\(/g, '（').replace(/\)/g, '）'); // 替换括号为全角
            
            const attributeSelect = document.getElementById('dataAttribute');
            const attributeName = attributeSelect.options[attributeSelect.selectedIndex].text;

            // 创建文件名（包含过滤非法字符）
            const cleanFileName = `${ranchName}_${fishName}_${attributeName}_水质数据雷达图_${new Date().toISOString().slice(0,10)}`
                .replace(/[\\/:*?"<>|]/g, ''); // 移除非法文件字符

            // 创建高清Canvas
            const tempCanvas = document.createElement('canvas');
            const originalCanvas = document.getElementById('fishRadarChart');
            const scale = 2;
            
            tempCanvas.width = originalCanvas.width * scale;
            tempCanvas.height = originalCanvas.height * scale;
            tempCanvas.style.width = originalCanvas.width + 'px';
            tempCanvas.style.height = originalCanvas.height + 'px';

            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.scale(scale, scale);
            tempCtx.drawImage(originalCanvas, 0, 0);

            // 触发下载
            const link = document.createElement('a');
            link.download = `${cleanFileName}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载所有牧场鱼类数据
            loadAllFishData();
            
            // 绑定加载按钮事件
            document.getElementById('loadFishData').addEventListener('click', function() {
                updateFishDisplay();
                updateRadarChart(document.getElementById('fishSpecies').value);
            });
            
            // 绑定牧场选择变化事件
            document.getElementById('marineFarmSelect').addEventListener('change', function() {
                updateFishDisplay();
            });
            
            // 绑定数据属性选择变化事件
            document.getElementById('dataAttribute').addEventListener('change', function() {
                updateRadarChart(document.getElementById('fishSpecies').value);
            });
        });
        
        // ====== 鱼类数据导出功能 ======
        // 打开导出模态框时重置状态
        const exportFishModal = document.getElementById('exportFishModal');
        exportFishModal?.addEventListener('show.bs.modal', function() {
            document.getElementById('fishExportRanchSelect').value = '';
            document.getElementById('fishExportStatus').textContent = '';
        });
        // 导出按钮点击事件
        document.getElementById('startFishExportBtn')?.addEventListener('click', function() {
            const ranch = document.getElementById('fishExportRanchSelect').value;
            const status = document.getElementById('fishExportStatus');
            if (!ranch) {
                status.textContent = '请选择要导出的海洋牧场';
                return;
            }
            status.textContent = '正在导出...';
            const url = `/api/fish/export?ranch=${encodeURIComponent(ranch)}`;
            fetch(url).then(async res => {
                if (!res.ok) {
                    status.textContent = '导出失败';
                    return;
                }
                const blob = await res.blob();
                let filename = res.headers.get('Content-Disposition');
                if (filename) {
                    const match = filename.match(/filename\*=UTF-8''(.+)/);
                    if (match) filename = decodeURIComponent(match[1]);
                    else filename = `Fish_${ranch}.csv`;
                } else {
                    filename = `Fish_${ranch}.csv`;
                }
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                status.textContent = '导出完成';
            }).catch(() => {
                status.textContent = '导出失败';
            });
        });
        
        // ====== 鱼类数据上传功能 ======
        const fishUploadRanchSelect = document.getElementById('fishUploadRanchSelect');
        const downloadFishTemplateBtn = document.getElementById('downloadFishTemplateBtn');
        const fishUploadDropArea = document.getElementById('fishUploadDropArea');
        const fishUploadFileInput = document.getElementById('fishUploadFileInput');
        const fishUploadStatus = document.getElementById('fishUploadStatus');
        const startFishUploadBtn = document.getElementById('startFishUploadBtn');
        let fishUploadFile = null;

        // 选择牧场后启用模板下载按钮
        fishUploadRanchSelect.addEventListener('change', function() {
            downloadFishTemplateBtn.disabled = !this.value;
            startFishUploadBtn.disabled = !this.value || !fishUploadFile;
            fishUploadStatus.textContent = '';
        });
        // 下载模板
        downloadFishTemplateBtn.addEventListener('click', function() {
            const ranch = fishUploadRanchSelect.value;
            if (!ranch) return;
            const url = `/api/fish/template?ranch=${encodeURIComponent(ranch)}`;
            fetch(url).then(async res => {
                if (!res.ok) return;
                const blob = await res.blob();
                let filename = `Fish_${ranch}.csv`;
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
            });
        });
        // 拖拽上传区域
        fishUploadDropArea.addEventListener('click', () => fishUploadFileInput.click());
        fishUploadDropArea.addEventListener('dragover', e => { e.preventDefault(); fishUploadDropArea.classList.add('bg-info'); });
        fishUploadDropArea.addEventListener('dragleave', e => { e.preventDefault(); fishUploadDropArea.classList.remove('bg-info'); });
        fishUploadDropArea.addEventListener('drop', function(e) {
            e.preventDefault();
            fishUploadDropArea.classList.remove('bg-info');
            if (e.dataTransfer.files.length) {
                fishUploadFileInput.files = e.dataTransfer.files;
                handleFishFileChange();
            }
        });
        fishUploadFileInput.addEventListener('change', handleFishFileChange);
        function handleFishFileChange() {
            const file = fishUploadFileInput.files[0];
            if (!file) { fishUploadFile = null; startFishUploadBtn.disabled = true; return; }
            if (!file.name.endsWith('.csv')) {
                fishUploadStatus.textContent = '仅支持CSV文件';
                fishUploadFile = null;
                startFishUploadBtn.disabled = true;
                return;
            }
            // 读取并校验格式
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split(/\r?\n/).filter(l => l.trim());
                const header = 'Species,Weight(g),Length1(cm),Length2(cm),Length3(cm),Height(cm),Width(cm)';
                if (!lines.length || lines[0].replace(/\s/g, '') !== header.replace(/\s/g, '')) {
                    fishUploadStatus.textContent = 'CSV首行格式不符';
                    fishUploadFile = null;
                    startFishUploadBtn.disabled = true;
                    return;
                }
                // 校验每行字段数
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].split(',').length !== 7) {
                        fishUploadStatus.textContent = `第${i+1}行字段数不符`;
                        fishUploadFile = null;
                        startFishUploadBtn.disabled = true;
                        return;
                    }
                }
                fishUploadStatus.textContent = `已选择文件：${file.name}`;
                fishUploadFile = file;
                startFishUploadBtn.disabled = !fishUploadRanchSelect.value;
            };
            reader.readAsText(file, 'utf-8');
        }
        // 上传表单提交
        document.getElementById('fishUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!fishUploadFile || !fishUploadRanchSelect.value) return;
            fishUploadStatus.textContent = '正在上传...';
            startFishUploadBtn.disabled = true;
            const formData = new FormData();
            formData.append('ranch', fishUploadRanchSelect.value);
            formData.append('file', fishUploadFile);
            fetch('/api/fish/upload', {
                method: 'POST',
                body: formData
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    fishUploadStatus.textContent = '上传并合并成功，共 ' + data.rows + ' 条数据';
                } else {
                    fishUploadStatus.textContent = data.msg || '上传失败';
                }
                startFishUploadBtn.disabled = false;
            }).catch(() => {
                fishUploadStatus.textContent = '上传失败';
                startFishUploadBtn.disabled = false;
            });
        });
        // 打开模态框时重置状态
        document.getElementById('uploadFishModal').addEventListener('show.bs.modal', function() {
            fishUploadRanchSelect.value = '';
            downloadFishTemplateBtn.disabled = true;
            fishUploadFileInput.value = '';
            fishUploadFile = null;
            fishUploadStatus.textContent = '';
            startFishUploadBtn.disabled = true;
        });

        // 预测功能相关变量
        let predictionChart = null;

        // 初始化预测按钮点击事件
        document.getElementById('predictBtn')?.addEventListener('click', function() {
            if (currentFishData.length === 0) {
                alert('请先加载鱼类数据');
                return;
            }
            
            const months = document.getElementById('predictionMonths').value;
            
            // 准备要发送的数据
            const fishDataForPrediction = currentFishData.map(fish => ({
                'Weight(g)': parseFloat(fish['Weight(g)']),
                'Length1(cm)': parseFloat(fish['Length1(cm)']),
                'Length2(cm)': parseFloat(fish['Length2(cm)']),
                'Length3(cm)': parseFloat(fish['Length3(cm)']),
                'Height(cm)': parseFloat(fish['Height(cm)']),
                'Width(cm)': parseFloat(fish['Width(cm)'])
            }));
            
            // 显示加载状态
            const predictBtn = document.getElementById('predictBtn');
            const originalText = predictBtn.innerHTML;
            predictBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>预测中...';
            predictBtn.disabled = true;
            
            // 发送预测请求
            fetch('/api/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fish_data: fishDataForPrediction,
                    months: months
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 显示预测结果
                    displayPredictionResults(data.predictions, data.prediction_date);
                } else {
                    alert('预测失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('预测请求失败:', error);
                alert('预测请求失败');
            })
            .finally(() => {
                predictBtn.innerHTML = originalText;
                predictBtn.disabled = false;
            });
        });

        // 显示预测结果
        function displayPredictionResults(predictions, predictionDate) {
            // 更新预测日期
            document.getElementById('predictionDate').textContent = predictionDate;
            
            // 填充预测表格
            const tableBody = document.getElementById('predictionTableBody');
            tableBody.innerHTML = '';
            
            predictions.forEach(pred => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pred.feature}</td>
                    <td>${pred.current_avg.toFixed(2)}</td>
                    <td>${pred.predicted_value.toFixed(2)}</td>
                    <td class="${pred.growth_rate >= 0 ? 'text-success' : 'text-danger'}">
                        ${pred.growth_rate.toFixed(2)}%
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // 显示预测结果区域
            document.getElementById('predictionResults').style.display = 'block';
            
            // 更新预测图表
            updatePredictionChart(predictions);
        }

        // 更新预测图表
        function updatePredictionChart(predictions) {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            
            // 如果已有图表，先销毁
            if (predictionChart) {
                predictionChart.destroy();
            }
            
            // 准备图表数据
            const labels = predictions.map(p => p.feature);
            const currentData = predictions.map(p => p.current_avg);
            const predictedData = predictions.map(p => p.predicted_value);
            
            predictionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '当前平均值',
                            data: currentData,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '预测值',
                            data: predictedData,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '数值'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '指标'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '当前数据与预测值对比'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    const growthRate = predictions[index].growth_rate;
                                    return `增长率: ${growthRate.toFixed(2)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>

{% endblock %}