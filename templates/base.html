<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æµ·æ´‹ç‰§åœºå¯è§†åŒ–ç³»ç»Ÿ</title>
    <!-- Bootstrap CSS -->
    <link href="https://unpkg.com/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="icon" type="image/png" sizes="32x32"href="{{ url_for('static', filename='images/favicon.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_v2.css') }}">
    <!-- FontAwesomeå›¾æ ‡åº“ï¼ˆç”¨äºåˆ é™¤æŒ‰é’®çš„å›¾æ ‡ï¼‰ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* csså†…è”ï¼Œé˜²æ­¢cssæ¸²æŸ“å¤±è´¥ */            
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --ocean-blue: #0077b6;
            --light-blue: #caf0f8;
            --dark-blue: #03045e;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-top: 56px; /* ä¸ºå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .navbar {
            background-color: var(--ocean-blue);
        }

        .navbar-brand, .nav-link {
            color: white !important;
            font-size: 0.9rem;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .main-content {
            padding: 20px;
            flex: 1;
        }

        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: var(--light-blue);
            color: var(--dark-blue);
            font-weight: bold;
        }

        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
        }

        canvas {
            width: 100% !important;
            height: auto !important;
        }

        .error-message {
            text-align: center;
            color: #e74c3c;
            padding: 20px;
            background-color: #fadbd8;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 600px;
        }

        .footer {
            background-color: var(--dark-blue);
            color: white;
            padding: 20px 0;
            margin-top: auto;
        }

        /* æµ·æ´‹ç‰§åœºé€‰æ‹©å™¨æ ·å¼ */
        .farm-selector {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .farm-selector label {
            color: white;
            font-weight: bold;
            margin-bottom: 0;
        }

        .farm-selector select {
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 6px 12px;
            min-width: 200px;
        }
        
        /* â˜… ç³»ç»Ÿæ—¥å¿—åŒºåŸŸå›ºå®šé«˜åº¦ + æ»šåŠ¨æ¡ */
        .log-scroll{
            max-height: 320px;   /* å¯æ ¹æ®éœ€è¦è°ƒé«˜/ä½ */
            overflow-y: auto;    /* å†…å®¹è¶…å‡ºæ—¶å‡ºç°å‚ç›´æ»šåŠ¨æ¡ */
        }
        
        /* â˜…å¯¼èˆªè¡Œè‡ªåŠ¨ç¼©æ”¾å­—ä½“â˜…  ------------------------- */
        .nav-auto-fit         { font-size: 16px; }        /* èµ·å§‹å­—å· */
        .nav-auto-fit a       { white-space: nowrap; }    /* ä¸å…è®¸å•é¡¹æ¢è¡Œ */

        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            
            .farm-selector {
                margin-top: 10px;
                width: 100%;
            }
            
            .farm-selector select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('main_info') }}">
                <i class="fas fa-water me-2"></i>æ™ºæ…§æµ·æ´‹ç‰§åœºå¯è§†åŒ–ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav nav-auto-fit">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main_info') }}"><i class="fas fa-home me-1"></i>é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('water_system') }}"><i class="fas fa-water me-1"></i>æ°´ä¸‹ç³»ç»Ÿ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('smart_center') }}"><i class="fas fa-brain me-1"></i>æ™ºèƒ½ä¸­å¿ƒ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('data_center') }}"><i class="fas fa-database me-1"></i>æ•°æ®ä¸­å¿ƒ</a>
                    </li>
                    <li class="nav-item">
                        {% if current_user.is_authenticated and current_user.role == 'admin' %}
                            <a class="nav-link" href="{{ url_for('admin_ctrl') }}"><i class="fas fa-user-cog me-1"></i> ç®¡ç†å‘˜ç®¡ç†</a>
                        {% endif %}
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}"><i class="fas fa-sign-out-alt me-1"></i>é€€å‡ºç™»å½•</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-user me-1"></i>{{ current_user.username }}ï¼Œæ¬¢è¿è¿›å…¥ç³»ç»Ÿï¼
                        </a>
                    </li>
                </ul>
                <!-- æµ·æ´‹ç‰§åœºé€‰æ‹©å™¨ -->
                <div class="farm-selector">
                    <label for="marineFarmSelect"><i class="fas fa-map-marker-alt me-1"></i>é€‰æ‹©æµ·æ´‹ç‰§åœºï¼š</label>
                    <select id="marineFarmSelect" class="form-select">
                        <option value="all">æµ·æ´‹ç‰§åœºæ€»è§ˆ</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        {% block content %}{% endblock %}
    </div>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="text-center">
                <p>Â© 2025 æ™ºæ…§æµ·æ´‹ç‰§åœºå¯è§†åŒ–ç³»ç»Ÿ | è½¯ä»¶å·¥ç¨‹ï¼šç¬¬ä¸‰å°ç»„ å¾äºšæ°‘ è‚–èƒœæ° å¼ é“­ å¼ é«˜ æ½˜å å®‡</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // æµ·æ´‹ç‰§åœºä½ç½®æ•°æ®
        const marineRanches = [
            {
                name: 'å±±ä¸œé’å²›', 
                value: [120.38, 36.07, 100], 
                desc: 'é’å²›å›½å®¶çº§æµ·æ´‹ç‰§åœºç¤ºèŒƒåŒº',
                province: 'å±±ä¸œ',
                city: 'é’å²›',
                exactLocation: [120.38, 36.07]
            },
            {
                name: 'æµ™æ±ŸèˆŸå±±', 
                value: [122.21, 29.99, 80], 
                desc: 'èˆŸå±±ç¾¤å²›æµ·æ´‹ç‰§åœº',
                province: 'æµ™æ±Ÿ',
                city: 'èˆŸå±±',
                exactLocation: [122.21, 29.99]
            },
            {
                name: 'ç¦å»ºå¦é—¨', 
                value: [118.11, 24.49, 70], 
                desc: 'å¦é—¨æ¹¾æµ·æ´‹ç‰§åœº',
                province: 'ç¦å»º',
                city: 'å¦é—¨',
                exactLocation: [118.11, 24.49]
            },
            {
                name: 'å¹¿ä¸œæ¹›æ±Ÿ', 
                value: [110.36, 21.27, 65], 
                desc: 'æ¹›æ±Ÿæµ·æ´‹ç‰§åœº',
                province: 'å¹¿ä¸œ',
                city: 'æ¹›æ±Ÿ',
                exactLocation: [110.36, 21.27]
            },
            {
                name: 'è¾½å®å¤§è¿', 
                value: [121.62, 38.92, 85], 
                desc: 'å¤§è¿æµ·æ´‹ç‰§åœº',
                province: 'è¾½å®',
                city: 'å¤§è¿',
                exactLocation: [121.62, 38.92]
            },
            {
                name: 'æ²³åŒ—ç§¦çš‡å²›', 
                value: [119.60, 39.94, 55], 
                desc: 'ç§¦çš‡å²›æµ·æ´‹ç‰§åœº',
                province: 'æ²³åŒ—',
                city: 'ç§¦çš‡å²›',
                exactLocation: [119.60, 39.94]
            }
        ];

        // åˆå§‹åŒ–æµ·æ´‹ç‰§åœºé€‰æ‹©å™¨
        function initMarineFarmSelector() {
            const select = document.getElementById('marineFarmSelect');
            
            // å¡«å……é€‰é¡¹
            marineRanches.forEach((ranch, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${ranch.name} - ${ranch.desc}`;
                select.appendChild(option);
            });
            
            // ä»localStorageè·å–ä¸Šæ¬¡é€‰æ‹©çš„ç‰§åœº
            const savedFarmIndex = localStorage.getItem('selectedMarineFarm');
            if (savedFarmIndex !== null && savedFarmIndex !== '') {
                select.value = savedFarmIndex;
                handleMarineFarmChange(savedFarmIndex);
            }
            
            // ç›‘å¬é€‰æ‹©å˜åŒ–
            select.addEventListener('change', function() {
                const selectedIndex = this.value;
                if (selectedIndex !== "") {
                    localStorage.setItem('selectedMarineFarm', selectedIndex);
                    handleMarineFarmChange(selectedIndex);
                }
            });
        }

        // å¤„ç†æµ·æ´‹ç‰§åœºé€‰æ‹©å˜åŒ–
        function handleMarineFarmChange(index) {
            const selectedRanch = marineRanches[index];
            
            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œå…¶ä»–ç»„ä»¶å¯ä»¥ç›‘å¬è¿™ä¸ªäº‹ä»¶æ¥æ›´æ–°æ•°æ®
            const event = new CustomEvent('marineFarmChanged', { 
                detail: selectedRanch 
            });
            window.dispatchEvent(event);
            
            // å¦‚æœéœ€è¦åˆ·æ–°é¡µé¢æˆ–è€…å‘é€åˆ°åç«¯
            // location.reload(); // åˆ·æ–°é¡µé¢
            // æˆ–è€…
            // sendToBackend(selectedRanch); // å‘é€åˆ°åç«¯
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMarineFarmSelector();
        });

        // ç›‘å¬æµ·æ´‹ç‰§åœºå˜åŒ–äº‹ä»¶çš„ç¤ºä¾‹ä»£ç 
        window.addEventListener('marineFarmChanged', function(e) {
            const ranch = e.detail;
            // åœ¨è¿™é‡Œå¯ä»¥æ ¹æ®é€‰æ‹©çš„ç‰§åœºæ›´æ–°é¡µé¢æ•°æ®
            // updatePageData(ranch);
        });
    </script>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- å¼•å…¥å¤–éƒ¨JavaScriptæ–‡ä»¶ -->
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <!-- åŠ è½½ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- åŠ è½½ ECharts æ ¸å¿ƒåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<script>
    // å…¨å±€å˜é‡å£°æ˜
    let chinaMap = null;
    let weatherDataMap = {};
    let marineRanchWeatherMap = {};

    // å®šä¹‰çœä»½ä¸­å¿ƒç‚¹å’Œçœä¼šåŸå¸‚ï¼ˆç”¨äºè·å–å¤©æ°”æ•°æ®ï¼‰
    const provinces = [
        {name: 'åŒ—äº¬', value: [116.41, 39.90], fullName: 'åŒ—äº¬å¸‚'},
        {name: 'å¤©æ´¥', value: [117.20, 39.13], fullName: 'å¤©æ´¥å¸‚'},
        {name: 'æ²³åŒ—', value: [114.48, 38.03], fullName: 'æ²³åŒ—çœ'},
        {name: 'å±±è¥¿', value: [112.55, 37.87], fullName: 'å±±è¥¿çœ'},
        {name: 'å†…è’™å¤', value: [111.65, 40.82], fullName: 'å†…è’™å¤è‡ªæ²»åŒº'},
        {name: 'è¾½å®', value: [123.43, 41.80], fullName: 'è¾½å®çœ'},
        {name: 'å‰æ—', value: [125.32, 43.82], fullName: 'å‰æ—çœ'},
        {name: 'é»‘é¾™æ±Ÿ', value: [126.63, 45.75], fullName: 'é»‘é¾™æ±Ÿçœ'},
        {name: 'ä¸Šæµ·', value: [121.47, 31.23], fullName: 'ä¸Šæµ·å¸‚'},
        {name: 'æ±Ÿè‹', value: [118.78, 32.07], fullName: 'æ±Ÿè‹çœ'},
        {name: 'æµ™æ±Ÿ', value: [120.19, 30.26], fullName: 'æµ™æ±Ÿçœ'},
        {name: 'å®‰å¾½', value: [117.27, 31.86], fullName: 'å®‰å¾½çœ'},
        {name: 'ç¦å»º', value: [119.30, 26.08], fullName: 'ç¦å»ºçœ'},
        {name: 'æ±Ÿè¥¿', value: [115.89, 28.68], fullName: 'æ±Ÿè¥¿çœ'},
        {name: 'å±±ä¸œ', value: [117.00, 36.67], fullName: 'å±±ä¸œçœ'},
        {name: 'æ²³å—', value: [113.65, 34.76], fullName: 'æ²³å—çœ'},
        {name: 'æ¹–åŒ—', value: [114.31, 30.59], fullName: 'æ¹–åŒ—çœ'},
        {name: 'æ¹–å—', value: [113.00, 28.21], fullName: 'æ¹–å—çœ'},
        {name: 'å¹¿ä¸œ', value: [113.26, 23.13], fullName: 'å¹¿ä¸œçœ'},
        {name: 'å¹¿è¥¿', value: [108.33, 22.84], fullName: 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº'},
        {name: 'æµ·å—', value: [110.35, 20.02], fullName: 'æµ·å—çœ'},
        {name: 'é‡åº†', value: [106.55, 29.56], fullName: 'é‡åº†å¸‚'},
        {name: 'å››å·', value: [104.07, 30.67], fullName: 'å››å·çœ'},
        {name: 'è´µå·', value: [106.71, 26.57], fullName: 'è´µå·çœ'},
        {name: 'äº‘å—', value: [102.73, 25.04], fullName: 'äº‘å—çœ'},
        {name: 'è¥¿è—', value: [91.11, 29.97], fullName: 'è¥¿è—è‡ªæ²»åŒº'},
        {name: 'é™•è¥¿', value: [108.95, 34.27], fullName: 'é™•è¥¿çœ'},
        {name: 'ç”˜è‚ƒ', value: [103.73, 36.03], fullName: 'ç”˜è‚ƒçœ'},
        {name: 'é’æµ·', value: [101.78, 36.56], fullName: 'é’æµ·çœ'},
        {name: 'å®å¤', value: [106.27, 38.47], fullName: 'å®å¤å›æ—è‡ªæ²»åŒº'},
        {name: 'æ–°ç–†', value: [87.62, 43.82], fullName: 'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº'},
        {name: 'å°æ¹¾', value: [121.50, 25.05], fullName: 'å°æ¹¾çœ'},
        {name: 'é¦™æ¸¯', value: [114.17, 22.28], fullName: 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº'},
        {name: 'æ¾³é—¨', value: [113.54, 22.19], fullName: 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº'}
    ];

    // å¤©æ°”ä»£ç æ˜ å°„è¡¨
    const weatherCodeMap = {
        0: { text: 'æ™´æœ—', icon: 'â˜€ï¸' },
        1: { text: 'å¤§è‡´æ™´æœ—', icon: 'ğŸŒ¤ï¸' },
        2: { text: 'éƒ¨åˆ†å¤šäº‘', icon: 'â›…' },
        3: { text: 'é˜´å¤©', icon: 'â˜ï¸' },
        45: { text: 'æœ‰é›¾', icon: 'ğŸŒ«ï¸' },
        48: { text: 'æ²‰ç§¯é›¾å‡‡', icon: 'ğŸŒ«ï¸' },
        51: { text: 'å°æ¯›æ¯›é›¨', icon: 'ğŸŒ¦ï¸' },
        53: { text: 'ä¸­åº¦æ¯›æ¯›é›¨', icon: 'ğŸŒ¦ï¸' },
        55: { text: 'æµ“æ¯›æ¯›é›¨', icon: 'ğŸŒ¦ï¸' },
        56: { text: 'å†»æ¯›æ¯›é›¨', icon: 'ğŸŒ¦ï¸' },
        57: { text: 'å¼ºå†»æ¯›æ¯›é›¨', icon: 'ğŸŒ¦ï¸' },
        61: { text: 'å°é›¨', icon: 'ğŸŒ§ï¸' },
        63: { text: 'ä¸­é›¨', icon: 'ğŸŒ§ï¸' },
        65: { text: 'å¤§é›¨', icon: 'ğŸŒ§ï¸' },
        66: { text: 'å†»é›¨', icon: 'ğŸŒ§ï¸' },
        67: { text: 'å¼ºå†»é›¨', icon: 'ğŸŒ§ï¸' },
        71: { text: 'å°é›ª', icon: 'â„ï¸' },
        73: { text: 'ä¸­é›ª', icon: 'â„ï¸' },
        75: { text: 'å¤§é›ª', icon: 'â„ï¸' },
        77: { text: 'é›ªç²’', icon: 'â„ï¸' },
        80: { text: 'å°é˜µé›¨', icon: 'ğŸŒ§ï¸' },
        81: { text: 'ä¸­é˜µé›¨', icon: 'ğŸŒ§ï¸' },
        82: { text: 'å¤§é˜µé›¨', icon: 'ğŸŒ§ï¸' },
        85: { text: 'å°é˜µé›ª', icon: 'ğŸŒ¨ï¸' },
        86: { text: 'å¤§é˜µé›ª', icon: 'ğŸŒ¨ï¸' },
        95: { text: 'é›·æš´', icon: 'â›ˆï¸' },
        96: { text: 'é›·æš´ä¼´æœ‰å°å†°é›¹', icon: 'â›ˆï¸' },
        99: { text: 'é›·æš´ä¼´æœ‰å¤§å†°é›¹', icon: 'â›ˆï¸' }
    };

    // æ ¹æ®å¤©æ°”ä»£ç è·å–å¤©æ°”æ–‡æœ¬æè¿°
    function getWeatherText(code) {
        return weatherCodeMap[code]?.text || 'æœªçŸ¥';
    }

    // æ ¹æ®å¤©æ°”ä»£ç è·å–å¤©æ°”å›¾æ ‡
    function getWeatherIcon(code) {
        return weatherCodeMap[code]?.icon || 'â“';
    }

    // è·å–æµ·æ´‹ç‰§åœºå¤©æ°”æ•°æ®
    async function fetchMarineRanchWeatherData(marineRanches) {
        const weatherData = [];
        
        // åˆ›å»ºè·å–å¤©æ°”æ•°æ®çš„ Promise æ•°ç»„
        const promises = marineRanches.map(ranch => {
            // æ„å»º Open-Meteo API URL
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${ranch.exactLocation[1]}&longitude=${ranch.exactLocation[0]}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m&timezone=auto`;
            
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    // å¤„ç†å¤©æ°”ä»£ç ä¸ºå¯è¯»æ–‡æœ¬
                    const weatherText = getWeatherText(data.current.weather_code);
                    const weatherIcon = getWeatherIcon(data.current.weather_code);
                    
                    // å°†å¤©æ°”æ•°æ®æ·»åŠ åˆ°æµ·æ´‹ç‰§åœºæ•°æ®ä¸­
                    weatherData.push({
                        name: ranch.name,
                        province: ranch.province,
                        city: ranch.city,
                        desc: ranch.desc,
                        exactLocation: ranch.exactLocation,
                        temp: data.current.temperature_2m,
                        humidity: data.current.relative_humidity_2m,
                        wind: data.current.wind_speed_10m,
                        windDirection: data.current.wind_direction_10m,
                        weather: weatherText,
                        weatherIcon: weatherIcon,
                        weatherCode: data.current.weather_code
                    });
                });
        });
        
        // ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆ
        await Promise.all(promises);
        
        return weatherData;
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadChinaMapData();
        setupPageLayout();
    });

    // è®¾ç½®é¡µé¢å¸ƒå±€ï¼Œåˆ›å»ºåœ°å›¾å’Œå¤©æ°”ä¿¡æ¯çš„å®¹å™¨
    function setupPageLayout() {
        // è·å–åŸå§‹å®¹å™¨
        const originalContainer = document.getElementById('chinaMap');
        if (!originalContainer) return;
        
        // è·å–çˆ¶å…ƒç´ 
        const parentElement = originalContainer.parentElement;
        
        // åˆ›å»ºæ–°çš„è¡Œå®¹å™¨
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row';
        
        // åˆ›å»ºåœ°å›¾åˆ—
        const mapColDiv = document.createElement('div');
        mapColDiv.className = 'col-md-8';
        
        // åˆ›å»ºå¤©æ°”ä¿¡æ¯åˆ—
        const weatherColDiv = document.createElement('div');
        weatherColDiv.className = 'col-md-4';
        weatherColDiv.id = 'weatherInfoContainer';
        
        // åˆ›å»ºæ–°çš„åœ°å›¾å®¹å™¨
        const newMapContainer = document.createElement('div');
        newMapContainer.id = 'chinaMap';
        newMapContainer.style.width = '100%';
        newMapContainer.style.height = '500px';
        
        // åˆ›å»ºé»˜è®¤çš„å¤©æ°”ä¿¡æ¯å¡ç‰‡
        const defaultWeatherCard = document.createElement('div');
        defaultWeatherCard.id = 'weatherInfo';
        defaultWeatherCard.className = 'card';
        defaultWeatherCard.innerHTML = `
            <div class="card-header bg-info text-white">
                <i class="fas fa-cloud me-2"></i>å¤©æ°”ä¿¡æ¯
            </div>
            <div class="card-body text-center">
                <p class="mb-0">ç‚¹å‡»åœ°å›¾ä¸Šçš„çœä»½æˆ–æµ·æ´‹ç‰§åœºæŸ¥çœ‹å¤©æ°”ä¿¡æ¯</p>
                <i class="fas fa-hand-pointer mt-3" style="font-size: 2rem; color: #ccc;"></i>
            </div>
        `;
        
        // ç»„è£…DOMç»“æ„
        mapColDiv.appendChild(newMapContainer);
        weatherColDiv.appendChild(defaultWeatherCard);
        rowDiv.appendChild(mapColDiv);
        rowDiv.appendChild(weatherColDiv);
        
        // æ›¿æ¢åŸå®¹å™¨
        parentElement.replaceChild(rowDiv, originalContainer);
    }

    // åŠ è½½ä¸­å›½åœ°å›¾æ•°æ®å¹¶åˆå§‹åŒ–åœ°å›¾
    function loadChinaMapData() {
        // ç­‰å¾…DOMæ›´æ–°åå†è·å–åœ°å›¾å®¹å™¨
        setTimeout(() => {
            // è·å–åœ°å›¾å®¹å™¨
            const mapContainer = document.getElementById('chinaMap');
            if (!mapContainer) {
                console.error('åœ°å›¾å®¹å™¨ä¸å­˜åœ¨');
                return;
            }
            
            // åˆå§‹åŒ– ECharts å®ä¾‹
            chinaMap = echarts.init(mapContainer);
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            chinaMap.showLoading();
            
            // åŠ è½½ä¸­å›½åœ°å›¾æ•°æ®
            fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json')
                .then(response => response.json())
                .then(chinaJson => {
                    // æ³¨å†Œåœ°å›¾æ•°æ®
                    echarts.registerMap('China', chinaJson);
                    
                    // è·å–çœä»½å¤©æ°”æ•°æ®
                    fetchWeatherData(provinces)
                        .then(weatherData => {
                            // å°†å¤©æ°”æ•°æ®è½¬æ¢ä¸ºæ˜ å°„è¡¨ä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾
                            weatherData.forEach(item => {
                                weatherDataMap[item.name] = item;
                            });
                            
                            // è·å–æµ·æ´‹ç‰§åœºå¤©æ°”æ•°æ®
                            fetchMarineRanchWeatherData(marineRanches)
                                .then(marineWeatherData => {
                                    // éšè—åŠ è½½åŠ¨ç”»
                                    chinaMap.hideLoading();
                                    
                                    // å°†æµ·æ´‹ç‰§åœºå¤©æ°”æ•°æ®è½¬æ¢ä¸ºæ˜ å°„è¡¨
                                    marineWeatherData.forEach(item => {
                                        marineRanchWeatherMap[item.name] = item;
                                    });
                                    
                                    // åˆ›å»ºåŒºåŸŸé¢œè‰²è®¾ç½®
                                    const regions = createRegionColors(provinces, weatherDataMap);
                                    
                                    // åˆ›å»ºåˆå§‹åœ°å›¾é€‰é¡¹
                                    const option = createMapOption(weatherDataMap, marineRanches, regions);
                                    
                                    // è®¾ç½®é…ç½®é¡¹å¹¶æ¸²æŸ“åœ°å›¾
                                    chinaMap.setOption(option);
                                    
                                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                                    chinaMap.on('click', function(params) {
                                        if (params.componentType === 'geo' && params.name) {
                                            // æ‰¾åˆ°å¯¹åº”çš„çœä»½
                                            const province = provinces.find(p => 
                                                p.fullName.includes(params.name) || 
                                                params.name.includes(p.name)
                                            );
                                            
                                            if (province && weatherDataMap[province.name]) {
                                                showProvinceWeather(params.name, weatherDataMap[province.name]);
                                            } else {
                                                console.log('æ²¡æœ‰æ‰¾åˆ°è¯¥çœä»½çš„å¤©æ°”æ•°æ®');
                                            }
                                        } else if (params.seriesType === 'effectScatter' && params.name) {
                                            // ç‚¹å‡»äº†æµ·æ´‹ç‰§åœº
                                            const marineRanchName = params.name;
                                            if (marineRanchWeatherMap[marineRanchName]) {
                                                showMarineRanchWeather(marineRanchName, marineRanchWeatherMap[marineRanchName]);
                                            } else {
                                                console.log('æ²¡æœ‰æ‰¾åˆ°è¯¥æµ·æ´‹ç‰§åœºçš„å¤©æ°”æ•°æ®');
                                            }
                                        }
                                    });
                                    
                                    // çª—å£å¤§å°å˜åŒ–æ—¶è‡ªåŠ¨è°ƒæ•´åœ°å›¾å¤§å°
                                    window.addEventListener('resize', function() {
                                        chinaMap.resize();
                                    });
                                })
                                .catch(error => {
                                    console.error('è·å–æµ·æ´‹ç‰§åœºå¤©æ°”æ•°æ®å¤±è´¥:', error);
                                    chinaMap.hideLoading();
                                    showError(mapContainer, 'è·å–æµ·æ´‹ç‰§åœºå¤©æ°”æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                                });
                        })
                        .catch(error => {
                            console.error('è·å–å¤©æ°”æ•°æ®å¤±è´¥:', error);
                            chinaMap.hideLoading();
                            showError(mapContainer, 'è·å–å¤©æ°”æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                        });
                })
                .catch(error => {
                    console.error('åŠ è½½ä¸­å›½åœ°å›¾æ•°æ®å¤±è´¥:', error);
                    chinaMap.hideLoading();
                    showError(mapContainer, 'æ— æ³•åŠ è½½ä¸­å›½åœ°å›¾æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                });
        }, 100);
    }

    // åˆ›å»ºåŒºåŸŸé¢œè‰²é…ç½®
    function createRegionColors(provinces, weatherDataMap) {
        const regions = [];
        
        // ä¸ºæ¯ä¸ªçœä»½åˆ›å»ºä¸€ä¸ªåŒºåŸŸé¢œè‰²é…ç½®
        provinces.forEach(province => {
            // æŸ¥æ‰¾å¯¹åº”çš„å¤©æ°”æ•°æ®
            const weatherData = weatherDataMap[province.name];
            
            if (weatherData) {
                // æ ¹æ®æ¸©åº¦è®¾ç½®é¢œè‰²
                const temp = weatherData.temp;
                // æ¸©åº¦èŒƒå›´ä»0åˆ°40åº¦ï¼Œå¯¹åº”é¢œè‰²ä»è“åˆ°çº¢
                const normalizedTemp = Math.min(Math.max(temp, 0), 40) / 40;
                
                // è®¡ç®—RGBé¢œè‰²å€¼
                const r = Math.floor(135 + 120 * normalizedTemp); // ä»135åˆ°255
                const g = Math.floor(206 - 137 * normalizedTemp); // ä»206åˆ°69
                const b = Math.floor(250 - 180 * normalizedTemp); // ä»250åˆ°70
                
                // æ·»åŠ åŒºåŸŸé…ç½®
                regions.push({
                    name: province.fullName,
                    itemStyle: {
                        areaColor: `rgb(${r},${g},${b})`
                    }
                });
            }
        });
        
        return regions;
    }

    // æ˜¾ç¤ºçœä»½å¤©æ°”çš„å‡½æ•°
    function showProvinceWeather(provinceName, weatherData) {
        // è·å–å¤©æ°”ä¿¡æ¯å®¹å™¨
        const weatherInfoContainer = document.getElementById('weatherInfoContainer');
        if (!weatherInfoContainer) return;
        
        // æ›´æ–°å¤©æ°”ä¿¡æ¯å†…å®¹
        const weatherInfo = document.getElementById('weatherInfo');
        if (weatherInfo) {
            weatherInfo.innerHTML = `
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-cloud me-2"></i>${provinceName}å¤©æ°”ä¿¡æ¯
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="display-1">${weatherData.weatherIcon}</span>
                        <h2 class="mt-2 mb-0">${weatherData.temp}Â°C</h2>
                        <h5 class="text-muted">${weatherData.weather}</h5>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-tint me-2 text-primary"></i>
                                <span class="fw-bold">æ¹¿åº¦</span>
                            </div>
                            <span>${weatherData.humidity}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: ${weatherData.humidity}%" 
                                aria-valuenow="${weatherData.humidity}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-wind me-2 text-secondary"></i>
                                <span class="fw-bold">é£é€Ÿ</span>
                            </div>
                            <span>${weatherData.wind} km/h</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-secondary" role="progressbar" style="width: ${Math.min(weatherData.wind * 5, 100)}%" 
                                aria-valuenow="${weatherData.wind}" aria-valuemin="0" aria-valuemax="20"></div>
                        </div>
                    </div>
                    <div class="mt-3 text-center small text-muted">
                        æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}<br>
                        æ•°æ®æ¥æº: Open-Meteo API
                    </div>
                </div>
            `;
        }
    }

    // æ˜¾ç¤ºæµ·æ´‹ç‰§åœºå¤©æ°”ä¿¡æ¯
    function showMarineRanchWeather(ranchName, weatherData) {
        // è·å–å¤©æ°”ä¿¡æ¯å®¹å™¨
        const weatherInfoContainer = document.getElementById('weatherInfoContainer');
        if (!weatherInfoContainer) return;
        
        // è·å–é£å‘æ–‡æœ¬æè¿°
        const windDirectionText = getWindDirectionText(weatherData.windDirection);
        
        // æ›´æ–°å¤©æ°”ä¿¡æ¯å†…å®¹
        const weatherInfo = document.getElementById('weatherInfo');
        if (weatherInfo) {
            weatherInfo.innerHTML = `
                <div class="card-header bg-info text-white">
                    <i class="fas fa-water me-2"></i>${ranchName}æµ·æ´‹ç‰§åœº
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="display-1">${weatherData.weatherIcon}</span>
                        <h2 class="mt-2 mb-0">${weatherData.temp}Â°C</h2>
                        <h5 class="text-muted">${weatherData.weather}</h5>
                        <p class="badge bg-secondary mt-2">${weatherData.desc}</p>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-tint me-2 text-primary"></i>
                                <span class="fw-bold">æ¹¿åº¦</span>
                            </div>
                            <span>${weatherData.humidity}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: ${weatherData.humidity}%" 
                                aria-valuenow="${weatherData.humidity}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-wind me-2 text-secondary"></i>
                                <span class="fw-bold">é£é€Ÿ</span>
                            </div>
                            <span>${weatherData.wind} km/h</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-secondary" role="progressbar" style="width: ${Math.min(weatherData.wind * 5, 100)}%" 
                                aria-valuenow="${weatherData.wind}" aria-valuemin="0" aria-valuemax="20"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-compass me-2 text-info"></i>
                                <span class="fw-bold">é£å‘</span>
                            </div>
                            <span>${windDirectionText} (${weatherData.windDirection}Â°)</span>
                        </div>
                        <div class="text-center mt-2">
                            <div class="direction-indicator" style="
                                display: inline-block;
                                width: 30px;
                                height: 30px;
                                border: 2px solid #17a2b8;
                                border-radius: 50%;
                                position: relative;
                            ">
                                <div style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    width: 0;
                                    height: 0;
                                    border-left: 10px solid transparent;
                                    border-right: 10px solid transparent;
                                    border-bottom: 20px solid #17a2b8;
                                    transform: translate(-50%, -50%) rotate(${weatherData.windDirection}deg);
                                    transform-origin: center;
                                "></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 small">
                        <div class="d-flex justify-content-between">
                            <div>
                                <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                                <span>ä½ç½®</span>
                            </div>
                            <span>${weatherData.city}, ${weatherData.province}</span>
                        </div>
                    </div>
                    <div class="mt-3 text-center small text-muted">
                        æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}<br>
                        æ•°æ®æ¥æº: Open-Meteo API
                    </div>
                </div>
            `;
        }
    }

    // è·å–é£å‘æ–‡å­—æè¿°
    function getWindDirectionText(degrees) {
        const directions = [
            'åŒ—é£', 'åŒ—åä¸œé£', 'ä¸œåŒ—é£', 'ä¸œååŒ—é£',
            'ä¸œé£', 'ä¸œåå—é£', 'ä¸œå—é£', 'å—åä¸œé£',
            'å—é£', 'å—åè¥¿é£', 'è¥¿å—é£', 'è¥¿åå—é£',
            'è¥¿é£', 'è¥¿ååŒ—é£', 'è¥¿åŒ—é£', 'åŒ—åè¥¿é£'
        ];
        
        // å°†è§’åº¦è½¬æ¢ä¸º16æ–¹ä½ç´¢å¼• (0-15)
        const index = Math.round(degrees / 22.5) % 16;
        return directions[index];
    }

    // å¼‚æ­¥è·å–å¤©æ°”æ•°æ®
    async function fetchWeatherData(provinces) {
        const weatherData = [];
        
        // åˆ›å»ºè·å–å¤©æ°”æ•°æ®çš„ Promise æ•°ç»„
        const promises = provinces.map(province => {
            // æ„å»º Open-Meteo API URL
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${province.value[1]}&longitude=${province.value[0]}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`;
            
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    // å¤„ç†å¤©æ°”ä»£ç ä¸ºå¯è¯»æ–‡æœ¬
                    const weatherText = getWeatherText(data.current.weather_code);
                    const weatherIcon = getWeatherIcon(data.current.weather_code);
                    
                    // å°†å¤©æ°”æ•°æ®æ·»åŠ åˆ°çœä»½æ•°æ®ä¸­
                    weatherData.push({
                        name: province.name,
                        fullName: province.fullName,
                        value: province.value,
                        temp: data.current.temperature_2m,
                        humidity: data.current.relative_humidity_2m,
                        wind: data.current.wind_speed_10m,
                        weather: weatherText,
                        weatherIcon: weatherIcon,
                        weatherCode: data.current.weather_code
                    });
                });
        });
        
        // ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆ
        await Promise.all(promises);
        
        return weatherData;
    }

    // åˆ›å»ºåœ°å›¾é…ç½®é€‰é¡¹
    function createMapOption(weatherDataMap, marineRanches, regions, selectedRanchIndex = null) {
        const selectedIndex = selectedRanchIndex !== null ? parseInt(selectedRanchIndex) : null;
        
        // åˆ›å»ºæµ·æ´‹ç‰§åœºæ•°æ®ç‚¹
        const scatterData = marineRanches.map((ranch, index) => {
            // æ˜ç¡®æ ‡è®°å½“å‰ç‰§åœºæ˜¯å¦è¢«é€‰ä¸­
            const isSelected = selectedIndex === index;
            
            return {
                name: ranch.name,
                value: ranch.exactLocation.concat(ranch.scale || 50), // ç¡®ä¿ç¬¬ä¸‰ä¸ªå€¼å­˜åœ¨ï¼ˆç”¨äºå¤§å°ï¼‰
                province: ranch.province,
                desc: ranch.description || '',
                isSelected: isSelected, // æ·»åŠ é€‰ä¸­æ ‡è®°
                // ç›´æ¥è®¾ç½®labelå±æ€§
                label: {
                    show: isSelected, // ç›´æ¥æ ¹æ®æ˜¯å¦é€‰ä¸­å†³å®šæ˜¯å¦æ˜¾ç¤ºæ ‡ç­¾
                    position: 'right',
                    formatter: '{b}',
                    fontSize: 14,
                    fontWeight: 'bold',
                    color: '#ff6600'
                },
                itemStyle: {
                    // ç›´æ¥åœ¨æ•°æ®ä¸­è®¾ç½®æ ·å¼ï¼Œè€Œä¸æ˜¯åœ¨å›è°ƒä¸­
                    color: isSelected ? '#ff6600' : '#00a6a6',
                    shadowBlur: isSelected ? 20 : 10,
                    shadowColor: isSelected ? '#ff6600' : '#333'
                },
                // å¦‚æœæœ‰å…¶ä»–å±æ€§ï¼Œä¿ç•™
                ...ranch
            };
        });

        return {
            title: {
                text: 'ä¸­å›½æµ·æ´‹ç‰§åœºåˆ†å¸ƒä¸å¤©æ°”æ¦‚å†µ',
                subtext: `æ•°æ®æ—¶é—´: ${new Date().toLocaleString()}`,
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.seriesType === 'effectScatter') {
                        // æµ·æ´‹ç‰§åœºæ•°æ®æ ¼å¼
                        const marineRanchName = params.name;
                        // è·å–å¯¹åº”çš„å¤©æ°”æ•°æ®
                        const weatherInfo = weatherDataMap[params.data.province];
                        
                        if (weatherInfo) {
                            return `
                                <div style="text-align:center;font-weight:bold;margin-bottom:5px;">${marineRanchName}</div>
                                <div>${params.data.desc}</div>
                                <hr style="margin:5px 0">
                                <div style="display:flex;align-items:center;margin-bottom:3px;">
                                    <span>${weatherInfo.weatherIcon}</span>
                                    <span style="margin-left:5px;">${weatherInfo.weather}</span>
                                </div>
                                <div>æ¸©åº¦: ${weatherInfo.temp}Â°C</div>
                                <div>è§„æ¨¡æŒ‡æ•°:${params.value[2]}</div>
                                <div style="font-style:italic;margin-top:5px;font-size:0.8em;">ç‚¹å‡»æŸ¥çœ‹ç²¾ç¡®å¤©æ°”ä¿¡æ¯</div>
                            `;
                        } else {
                            return `${params.name}<br/>è§„æ¨¡æŒ‡æ•°: ${params.value[2]}<br/>${params.data.desc}`;
                        }
                    } else if (params.componentType === 'geo') {
                        // çœä»½æ ¼å¼
                        const provinceName = params.name;
                        // æ‰¾åˆ°å¯¹åº”çš„ç®€ç§°
                        const provinceShortName = Object.keys(weatherDataMap).find(name => 
                            weatherDataMap[name].fullName === provinceName || 
                            provinceName.includes(name)
                        );
                        
                        if (provinceShortName && weatherDataMap[provinceShortName]) {
                            const data = weatherDataMap[provinceShortName];
                            return `
                                <div style="text-align:center;font-weight:bold;margin-bottom:5px;">${provinceName}</div>
                                <div style="display:flex;align-items:center;margin-bottom:3px;">
                                    <span>${data.weatherIcon}</span>
                                    <span style="margin-left:5px;">${data.weather}</span>
                                </div>
                                <div>æ¸©åº¦: ${data.temp}Â°C</div>
                                <div>æ¹¿åº¦: ${data.humidity}%</div>
                                <div>é£é€Ÿ: ${data.wind} km/h</div>
                                <div style="font-style:italic;margin-top:5px;font-size:0.8em;">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                            `;
                        } else {
                            return provinceName;
                        }
                    }
                }
            },
            visualMap: {
                show: true,
                min: 0,
                max: 40, // æ¸©åº¦èŒƒå›´ï¼Œå¯ä»¥æ ¹æ®å®é™…æ•°æ®è°ƒæ•´
                text: ['é«˜æ¸©', 'ä½æ¸©'],
                realtime: false,
                calculable: true,
                inRange: {
                    color: ['#87CEFA', '#FF4500'] // ä»è“è‰²(å†·)åˆ°çº¢è‰²(çƒ­)
                },
                left: 'left',
                seriesIndex: [],
                dimension: 0
            },
            geo: {
                map: 'China',
                roam: true, // å…è®¸ç¼©æ”¾å’Œå¹³ç§»
                scaleLimit: {
                    min: 1,
                    max: 10
                },
                center: [104.5, 38], // ä¸­å›½åœ°ç†ä¸­å¿ƒç‚¹
                zoom: 1.2, // åˆå§‹ç¼©æ”¾çº§åˆ«
                label: {
                    show: false
                },
                emphasis: {
                    label: {
                        show: true
                    },
                    itemStyle: {
                        areaColor: '#e6f7ff'
                    }
                },
                itemStyle: {
                    areaColor: '#f3f3f3', // é»˜è®¤é¢œè‰²
                    borderColor: '#ccc',
                    borderWidth: 1
                },
                regions: regions // æ·»åŠ åŒºåŸŸç‰¹å®šçš„æ ·å¼è®¾ç½®
            },
            series: [{
                name: 'æµ·æ´‹ç‰§åœº',
                type: 'effectScatter',
                coordinateSystem: 'geo',
                data: scatterData,
                symbolSize: function (val) {
                    return val[2] / 10;
                },
                showEffectOn: 'render',
                rippleEffect: {
                    brushType: 'stroke',
                    scale: 3,
                    period: 4
                },
                hoverAnimation: true,
                itemStyle: {
                    // ä¸è¦åœ¨è¿™é‡Œä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œè€Œæ˜¯åœ¨æ•°æ®ä¸­ç›´æ¥è®¾ç½®æ ·å¼
                    shadowBlur: 10,
                    shadowColor: '#333'
                },
                emphasis: {
                    label: {
                        show: false
                    },
                    itemStyle: {
                        // é¼ æ ‡æ‚¬åœæ—¶çš„æ ·å¼
                        shadowBlur: 20
                    }
                },
                zlevel: 1
            }]
        };
    }

    // ç›‘å¬æµ·æ´‹ç‰§åœºé€‰æ‹©å˜åŒ–å¹¶æ›´æ–°åœ°å›¾
    window.addEventListener('marineFarmChanged', function(e) {
        const selectedIndex = e.detail?.selectedIndex || document.getElementById('marineFarmSelect').value;
        const regions = createRegionColors(provinces, weatherDataMap);

        console.log(selectedIndex);
        
        // é‡æ–°åˆ›å»ºåœ°å›¾é…ç½®
        const newOption = createMapOption(weatherDataMap, marineRanches, regions, selectedIndex);
        
        // æ›´æ–°å›¾è¡¨
        if (chinaMap) {
            chinaMap.setOption(newOption);
            // å¦‚æœé€‰ä¸­äº†æŸä¸ªç‰§åœºï¼Œè‡ªåŠ¨ç¼©æ”¾åˆ°è¯¥ä½ç½®
            if (selectedIndex !== 0) {
                const selectedRanch = marineRanches[selectedIndex];
                if (selectedRanch && selectedRanch.exactLocation) {
                    chinaMap.setOption({
                        geo: {
                            center: selectedRanch.exactLocation,
                            zoom: 5 // æ”¾å¤§åˆ°åˆé€‚çš„çº§åˆ«
                        }
                    });
                }
            } else {
                // å¦‚æœæ˜¯"æ‰€æœ‰æµ·æ´‹ç‰§åœº"é€‰é¡¹ï¼Œé‡ç½®è§†å›¾
                chinaMap.setOption({
                    geo: {
                        center: [104.5, 38],
                        zoom: 1.2
                    }
                });
            }
        }
    });

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(container, message) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <strong>é”™è¯¯</strong><br>
                ${message}
            </div>
        `;
    }

    // åˆå§‹åŒ–è®¾å¤‡çŠ¶æ€å›¾è¡¨
    function initDeviceStatusChart() {
        const deviceStatusElement = document.getElementById('deviceStatusChart');
        if (deviceStatusElement) {
            const deviceStatusCtx = deviceStatusElement.getContext('2d');
            const deviceStatusChart = new Chart(deviceStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['æ­£å¸¸è¿è¡Œ', 'éœ€è¦ç»´æŠ¤', 'æ•…éšœ', 'ç¦»çº¿'],
                    datasets: [{
                        data: [75, 15, 5, 5],
                        backgroundColor: [
                            '#4caf50', // ç»¿è‰²ï¼šæ­£å¸¸è¿è¡Œ
                            '#ff9800', // æ©™è‰²ï¼šéœ€è¦ç»´æŠ¤
                            '#f44336', // çº¢è‰²ï¼šæ•…éšœ
                            '#9e9e9e'  // ç°è‰²ï¼šç¦»çº¿
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'è®¾å¤‡è¿è¡ŒçŠ¶æ€åˆ†å¸ƒ'
                        }
                    }
                }
            });
        } else {
            console.warn("æœªæ‰¾åˆ°è®¾å¤‡çŠ¶æ€å›¾è¡¨å…ƒç´ ");
        }
    }

    (function () {
    const MIN_SIZE = 12;    // å…è®¸ç¼©åˆ°çš„æœ€å°å­—å·ï¼ˆpxï¼‰
    const STEP     = 1;     // æ¯æ¬¡é€’å‡æ­¥é•¿

    const nav     = document.querySelector('.nav-auto-fit');
    if (!nav) return;       // é¡µé¢æ²¡æœ‰è¯¥å¯¼èˆªç›´æ¥è¿”å›

    function shrinkToFit () {
        /* è¿˜åŸåˆ°èµ·å§‹å­—å·å†å¼€å§‹æ£€æµ‹ */
        const start = parseFloat(getComputedStyle(nav).fontSize);
        let size    = start;

        nav.style.fontSize = start + 'px';

        /* åªè¦è¶…å®½ä¸”è¿˜èƒ½å˜å°ï¼Œå°±å¾ªç¯ç¼©å°å­—å· */
        while (nav.scrollWidth > nav.clientWidth && size > MIN_SIZE) {
            size -= STEP;
            nav.style.fontSize = size + 'px';
        }
    }

    /* åˆæ¬¡æ¸²æŸ“ã€çª—å£å˜åŠ¨æ—¶éƒ½æ‰§è¡Œä¸€æ¬¡ */
    window.addEventListener('load',   shrinkToFit);
    window.addEventListener('resize', shrinkToFit);
})();
</script>
</body>
</html>
